clear_aging_modifier_effect = {
	remove_character_modifier = ek_age_40_penalty
	remove_character_modifier = ek_age_45_penalty
	remove_character_modifier = ek_age_50_penalty
	remove_character_modifier = ek_age_55_penalty
	remove_character_modifier = ek_age_60_penalty
	remove_character_modifier = ek_age_65_penalty
	remove_character_modifier = ek_age_70_penalty
	remove_character_modifier = ek_age_75_penalty
	remove_character_modifier = ek_age_80_penalty
	remove_character_modifier = ek_age_85_penalty
	remove_character_modifier = ek_age_90_penalty
	remove_character_modifier = ek_age_95_penalty
	remove_character_modifier = ek_age_100_penalty
	remove_character_modifier = ek_age_105_penalty
	remove_character_modifier = ek_age_110_penalty
	remove_character_modifier = ek_age_115_penalty
	remove_character_modifier = ek_age_120_penalty
	remove_character_modifier = ek_age_125_penalty
	remove_character_modifier = ek_age_130_penalty
	remove_character_modifier = ek_age_135_penalty
	remove_character_modifier = ek_age_140_penalty
	remove_character_modifier = ek_age_145_penalty
	remove_character_modifier = ek_age_150_penalty
	remove_character_modifier = ek_age_155_penalty
	remove_character_modifier = ek_age_160_penalty
	remove_character_modifier = ek_age_165_penalty
	remove_character_modifier = ek_age_170_penalty
	remove_character_modifier = ek_age_175_penalty
	remove_character_modifier = ek_age_180_penalty
	remove_character_modifier = ek_age_195_penalty
	remove_character_modifier = ek_age_200_penalty

	remove_character_modifier = ek_age_40_penalty_no_prowess_loss_from_age
	remove_character_modifier = ek_age_45_penalty_no_prowess_loss_from_age
	remove_character_modifier = ek_age_50_penalty_no_prowess_loss_from_age
	remove_character_modifier = ek_age_55_penalty_no_prowess_loss_from_age
	remove_character_modifier = ek_age_60_penalty_no_prowess_loss_from_age
	remove_character_modifier = ek_age_65_penalty_no_prowess_loss_from_age
	remove_character_modifier = ek_age_70_penalty_no_prowess_loss_from_age
	remove_character_modifier = ek_age_75_penalty_no_prowess_loss_from_age
	remove_character_modifier = ek_age_80_penalty_no_prowess_loss_from_age
	remove_character_modifier = ek_age_85_penalty_no_prowess_loss_from_age
	remove_character_modifier = ek_age_90_penalty_no_prowess_loss_from_age
	remove_character_modifier = ek_age_95_penalty_no_prowess_loss_from_age
	remove_character_modifier = ek_age_100_penalty_no_prowess_loss_from_age
	remove_character_modifier = ek_age_105_penalty_no_prowess_loss_from_age
	remove_character_modifier = ek_age_110_penalty_no_prowess_loss_from_age
	remove_character_modifier = ek_age_115_penalty_no_prowess_loss_from_age
	remove_character_modifier = ek_age_120_penalty_no_prowess_loss_from_age
	remove_character_modifier = ek_age_125_penalty_no_prowess_loss_from_age
	remove_character_modifier = ek_age_130_penalty_no_prowess_loss_from_age
	remove_character_modifier = ek_age_135_penalty_no_prowess_loss_from_age
	remove_character_modifier = ek_age_140_penalty_no_prowess_loss_from_age
	remove_character_modifier = ek_age_145_penalty_no_prowess_loss_from_age
	remove_character_modifier = ek_age_150_penalty_no_prowess_loss_from_age
	remove_character_modifier = ek_age_155_penalty_no_prowess_loss_from_age
	remove_character_modifier = ek_age_160_penalty_no_prowess_loss_from_age
	remove_character_modifier = ek_age_165_penalty_no_prowess_loss_from_age
	remove_character_modifier = ek_age_170_penalty_no_prowess_loss_from_age
	remove_character_modifier = ek_age_175_penalty_no_prowess_loss_from_age
	remove_character_modifier = ek_age_180_penalty_no_prowess_loss_from_age
	remove_character_modifier = ek_age_195_penalty_no_prowess_loss_from_age
	remove_character_modifier = ek_age_200_penalty_no_prowess_loss_from_age
}

startup_culture_effect = {
	save_culture_in_global_list = { CULTURE = culture:$CULTURE$ }
	culture_key_setup = { CULTURE = $CULTURE$ }
}

culture_key_setup = {
	culture:$CULTURE$ = {
		set_variable = { name = culture_key value = flag:$CULTURE$_ }
		if = { limit = { var:culture_key = flag:$CULTURE$_ } }
	}
}

interregnum_potentate_death_early_trigger = {
	## The Potentate is shattered
	hidden_effect = { destroy_title = title:e_cyrodiilic_potentate }
	every_vassal = {
		limit = {
			is_de_jure_vassal_of_liege_trigger = no
		}
		create_title_and_vassal_change = {
			type = independency
			save_scope_as = change
			add_claim_on_loss = yes
		}
		becomes_independent = {
			change = scope:change
		}
		resolve_title_and_vassal_change = scope:change
	}
}

break_up_cyrodiil_scripted_effect = {
	#Colovia
	every_kingdom = { #Grab every kingdom in Colovia+Bruma
		limit = {
			title_capital_county.title_province = {
				OR = {
					geographical_region = mundus_tamriel_cyrodiil_colovia
					geographical_region = mundus_tamriel_cyrodiil_bruma
				}
			}
			target_is_de_jure_liege_or_above = title:e_cyrodiil
		}
		set_de_jure_liege_title = title:e_colovian_estates
	}
	# Nibenay
	every_kingdom = { #Grab every kingdom in Nibenay+Heartlands
		limit = {
			title_capital_county.title_province = {
				OR = {
					geographical_region = mundus_tamriel_cyrodiil_nibenay
					geographical_region = mundus_tamriel_cyrodiil_heartlands
				}
			}
			target_is_de_jure_liege_or_above = title:e_cyrodiil
		}
		set_de_jure_liege_title = title:e_nibenay
	}
	if = { #If Cyrodiil somehow grabbed Systres before shattering, it goes to Hammerfell
		limit = { title:e_cyrodiil = { is_de_jure_liege_or_above_target = title:k_systres }}
		title:k_systres = { set_de_jure_liege_title = title:e_hammerfell  }
	}
	title:e_colovian_estates = { add_title_law = feudal_elective_succession_law }
	title:e_nibenay = { add_title_law = feudal_elective_succession_law }
	title:e_nibenay = { set_capital_county = title:c_imperial_city }
}

#Reunite Cyrodiil
reunite_cyrodiil_scripted_effect = {
	title:e_colovian_estates = {
		every_in_de_jure_hierarchy = {
			limit = {
				tier = tier_kingdom
			}
			set_de_jure_liege_title = title:e_cyrodiil
		}
	}
	title:e_nibenay = {
		every_in_de_jure_hierarchy = {
			limit = {
				tier = tier_kingdom
			}
			set_de_jure_liege_title = title:e_cyrodiil
		}
	}
}

#Dissolution of Elsweyr
dissolve_elsweyr_scripted_effect = {
	title:e_elsweyr.holder = {save_scope_as = mane}
	#Anequina
	every_kingdom = { #Grab every kingdom in Colovia+Bruma
		limit = {
			title_capital_county.title_province = {
				geographical_region = mundus_tamriel_elsweyr_anequina
			}
			target_is_de_jure_liege_or_above = title:e_elsweyr
		}
		set_de_jure_liege_title = title:e_anequina
	}
	#Pellitine
	every_kingdom = { #Grab every kingdom in Colovia+Bruma
		limit = {
			title_capital_county.title_province = {
				geographical_region = mundus_tamriel_elsweyr_pellitine
			}
			target_is_de_jure_liege_or_above = title:e_elsweyr
		}
		set_de_jure_liege_title = title:e_pellitine
	}
	if = { #If Elsweyr somehow managed to grab Arenthia before falling apart, then it goes back to Bosmers
		limit = { title:e_elsweyr = { is_de_jure_liege_or_above_target = title:k_arenthia }}
		title:k_arenthia = { set_de_jure_liege_title = title:e_valenwood  }
	}
	#Checking for Leyawiin decision
	if = { #If Elsweyr managed to get Leyawiin before falling apart, Alabaster gets de jure ownership of it
		limit = { title:e_elsweyr = { is_de_jure_liege_or_above_target = title:d_leyawiin }}
		title:d_leyawiin = { set_de_jure_liege_title = title:k_alabaster }
	}
	if = { #If Elsweyr managed to get Nomore before falling apart, Rimmen gets de jure ownership of it
		limit = { title:e_elsweyr = { is_de_jure_liege_or_above_target = title:d_nomore }}
		title:d_nomore = { set_de_jure_liege_title = title:k_rimmen }
	}
	add_to_global_variable_list = {
		name = elsweyr_variables
		target = flag:elsweyr_dissolved
	}
	#Global flag to allow people to leave Elsweyr for 30 years
	add_to_global_variable_list = {
		name = elsweyr_variables
		target = flag:elsweyr_can_secede
		years = 30
	}
	every_player = { 
		trigger_event = {
			id = elsweyr.0005 
			days = 1 #this delay allows some scopes to fall properly into place
		}
	}
}

reunite_elsweyr_scripted_effect = {
	title:e_anequina = {
		every_in_de_jure_hierarchy = {
			limit = {
				tier = tier_kingdom
			}
			set_de_jure_liege_title = title:e_elsweyr
		}
	}
	title:e_pellitine = {
		every_in_de_jure_hierarchy = {
			limit = {
				tier = tier_kingdom
			}
			set_de_jure_liege_title = title:e_elsweyr
		}
	}
}

#Break up Skyrim
break_up_skyrim_scripted_effect = {
	# Western Skyrim
	every_kingdom = { #Grab every kingdom in Western Skyrim
		limit = {
			title_capital_county.title_province = {
				OR = {
					geographical_region = mundus_tamriel_skyrim_west_skyrim
					geographical_region = mundus_tamriel_skyrim_karth
				}
			}
			target_is_de_jure_liege_or_above = title:e_skyrim #Checking if it's de jure vassal of Skyrim
		}
		set_de_jure_liege_title = title:e_western_skyrim
	}
	# Eastern Skyrim
	every_kingdom = { #Grab every kingdom in Eastern Skyrim+Solstheim
		limit = {
			title_capital_county.title_province = {
				OR = {
					geographical_region = mundus_tamriel_skyrim_east_skyrim
					geographical_region = mundus_tamriel_skyrim_solstheim
				}
			}
			target_is_de_jure_liege_or_above = title:e_skyrim
		}
		set_de_jure_liege_title = title:e_eastern_skyrim
	}
}
#Reunite Skyrim
reunite_skyrim_scripted_effect = {
	title:e_western_skyrim = {
		every_in_de_jure_hierarchy = {
			limit = {
				tier = tier_kingdom
			}
			set_de_jure_liege_title = title:e_skyrim
		}
	}
	title:e_eastern_skyrim = {
		every_in_de_jure_hierarchy = {
			limit = {
				tier = tier_kingdom
			}
			set_de_jure_liege_title = title:e_skyrim
		}
	}
}

# Tsaesci Act stuff
attrebus_take_akaviri_county = {
	$COUNTY$ = {
		random_in_list = {
			variable = native_culture_list
			limit = { has_same_culture_heritage = $ATTREBUS$.culture }
			save_scope_as = new_culture
		}
		if = { # Just in case
			limit = { NOT = { exists = scope:new_culture } }
			$ATTREBUS$.culture = { save_scope_as = new_culture }
		}
		set_county_culture = scope:new_culture
		
		set_variable = {
			name = curr_dev
			value = development_level
		}
		change_variable = {
			name = curr_dev
			divide = -2
		}
		change_development_level = var:curr_dev
	}
	$ATTREBUS$ = {
		send_interface_toast = {
			type = event_generic_neutral
			title = attrebus_tsaesci_county_title
			custom_tooltip = attrebus_tsaesci_county_desc
			
			show_as_tooltip = {
				$COUNTY$ = {
					set_county_culture = scope:new_culture
					change_development_level = var:curr_dev
				}
			}
		}
	}
}

attrebus_take_akaviri_vassal = {
	$VASSAL$ = {
		# Kingdom -> Duchies -> Counties -> Baronies
		create_title_and_vassal_change = {
			type = revoked
			save_scope_as = title_change
			add_claim_on_loss = no
		}
		every_held_title = {
			limit = { tier = tier_kingdom }
			change_title_holder = {
				holder = $ATTREBUS$
				change = scope:title_change
			}
		}
		resolve_title_and_vassal_change = scope:title_change
		#
		create_title_and_vassal_change = {
			type = revoked
			save_scope_as = title_change
			add_claim_on_loss = no
		}
		every_held_title = {
			limit = { tier = tier_duchy }
			change_title_holder = {
				holder = $ATTREBUS$
				change = scope:title_change
			}
		}
		resolve_title_and_vassal_change = scope:title_change
		#
		create_title_and_vassal_change = {
			type = revoked
			save_scope_as = title_change
			add_claim_on_loss = no
		}
		every_held_title = {
			limit = { tier = tier_county }
			change_title_holder = {
				holder = $ATTREBUS$
				change = scope:title_change
			}
		}
		resolve_title_and_vassal_change = scope:title_change
		#
		create_title_and_vassal_change = {
			type = revoked
			save_scope_as = title_change
			add_claim_on_loss = no
		}
		every_held_title = {
			limit = { tier = tier_barony }
			change_title_holder = {
				holder = $ATTREBUS$
				change = scope:title_change
			}
		}
		resolve_title_and_vassal_change = scope:title_change
	}
}

### To easily apply the effects of the Plunderer perks and pirate government
raid_dynasty_prestige_effect = {
	if = {
		limit = {
			scope:raider = {
				has_perk = tales_of_glory_perk 
				exists = dynasty 
			}
		}
		scope:raider.dynasty = {		
			add_dynasty_prestige = {
				value = scope:raid_loot
				divide = 20
			}
		}
	}
}

raid_piety_effect = {
	if = {
		limit = {
			faith = { has_doctrine_parameter = holy_wars_forbidden }
			NOT = { has_perk = bountiful_offerings_perk }
		}
		add_piety = {
			value = scope:raid_loot
			multiply = -1
		}
	}
	if = {
		limit = {
			scope:raider = {
				NOT = { faith = { has_doctrine_parameter = holy_wars_forbidden } }
				has_perk = bountiful_offerings_perk
			}
		}
		add_piety = scope:raid_loot
	}
}

pirate_redistribution_effect = {
	hidden_effect = { remove_short_term_gold = scope:raid_loot }
	set_variable = {
		name = gold_gained
		value = scope:raid_loot
	}
	if = {
		limit = {
			has_royal_court = yes 
			exists = scope:raid_loot
		}
		
		### Given to commoners
		save_scope_value_as = {
			name = pirate_loot_redistribution_commoners
			value = {
				value = scope:raid_loot
				divide = 20
				multiply = pirate_court_redistribution_level.sub1
			}
		}
		### Given to the crew
		save_scope_value_as = {
			name = pirate_loot_redistribution_crew
			value = {
				value = scope:raid_loot
				divide = 20
				multiply = pirate_court_crew_level.sub1
			}
		}
		### Given to Knights
		save_scope_value_as = {
			name = pirate_loot_redistribution_knights
			value = {
				value = scope:raid_loot
				divide = 20
				multiply = pirate_court_knights_level.sub1
			}
		}
		### Turned into Grandeur
		save_scope_value_as = {
			name = pirate_loot_redistribution_court
			value = {
				value = scope:raid_loot
				divide = 20
				multiply = pirate_court_court_level.sub1
			}
		}
		
		if = {
			limit = { 
				number_of_knights >= 1 
				scope:pirate_loot_redistribution_knights > 0 
			}
			
			# How much is given to a single knight?
			save_scope_value_as = {
				name = pirate_loot_redistribution_knights_individual_gain
				value = {
					value = scope:pirate_loot_redistribution_knights
					divide = number_of_knights
				}
			}
			
			# Give it to 'em
			if = {
				limit = { scope:pirate_loot_redistribution_knights_individual_gain > 0 }
				every_knight = {
					add_gold = scope:pirate_loot_redistribution_knights_individual_gain
				}
			}
		}
		
		# Get the grandeur
		if = {
			limit = { 
				exists = scope:pirate_loot_redistribution_court 
				scope:pirate_loot_redistribution_court > 0 
			}
			change_current_court_grandeur = scope:pirate_loot_redistribution_court
		}
	}
	#Subtract the distributed gold from the gold gained by the ruler
	if = {
		limit = { 
			exists = scope:pirate_loot_redistribution_commoners 
			scope:pirate_loot_redistribution_commoners > 0 
		}
		change_variable = {
			name = gold_gained
			subtract = scope:pirate_loot_redistribution_commoners
		}
	}
	if = {
		limit = { 
			exists = scope:pirate_loot_redistribution_crew 
			scope:pirate_loot_redistribution_crew > 0 
		}
		change_variable = {
			name = gold_gained
			subtract = scope:pirate_loot_redistribution_crew
		}
	}
	if = {
		limit = { 
			exists = scope:pirate_loot_redistribution_knights 
			scope:pirate_loot_redistribution_knights > 0 
		}
		change_variable = {
			name = gold_gained
			subtract = scope:pirate_loot_redistribution_knights
		}
	}
	if = {
		limit = { 
			exists = scope:pirate_loot_redistribution_court 
			scope:pirate_loot_redistribution_court > 0 
		}
		change_variable = {
			name = gold_gained
			subtract = scope:pirate_loot_redistribution_court
		}
	}
	save_scope_value_as = {
		name = gold_gained
		value = var:gold_gained
	}
	if = {
		limit = { scope:gold_gained > 0 }
		hidden_effect = { add_gold = scope:gold_gained }
	}
}

### Checks if you should fire the blood price event
# Fired from the imprison character scripted effects
# Needs $TARGET$ and $IMPRISONER$
ek_fire_blood_price_event = {
	if = {
		limit = { $IMPRISONER$.culture = { has_innovation = innovation_blood_price } }
		$TARGET$ = { add_character_flag = ek_fire_blood_price_flag }
	}
}

### Checks if you should fire the ashlander exile event
# Fired from the imprison character scripted effects
# Needs $TARGET$ and $IMPRISONER$
ek_fire_ashlander_exile_event = {
	if = {
		limit = { 
			$IMPRISONER$.culture = { has_cultural_tradition = tradition_red_mountain_might }
			$TARGET$.liege = $IMPRISONER$
		}
		$TARGET$ = { add_character_flag = ek_ashlander_exile }
	}
}

### Wound two times in a row, no death
increase_wounds_two_times_no_death_effect = {
	save_temporary_scope_value_as = {
		name = treatment_type
		value = flag:$REASON$
	}

	change_trait_rank = {
		trait = wounded
		rank = 2 #the vanilla effect adds only one rank, otherwise it's identical
		max = 3
	}

	if = { #Wounds from treatments give no infection and no additional treatment
		limit = { NOT = { scope:treatment_type = flag:treatment } }

		#CHANCE OF INFECTION
		hidden_effect = {
			random = {
				chance = 10
				trigger_event = {
					id = health.0201
					days = { 30 60 }
				}
			}
		}

		#HANDLE TREATMENT
		if = { #To send notification message or trigger the right event
			limit = {
				has_trait_rank = {
					trait = wounded
					rank = 1
				}
				court_physician_available_trigger = yes
			}
			save_scope_as = sick_character
			safe_wound_treatment_effect = yes #Wounded 1 only gives a "result of treatment" notification" if you have a physician, i.e. you get no events about it.
		}
		else_if = {
			limit = {
				has_trait_rank = {
					trait = wounded
					rank = 2
				}
				has_recent_wound_treatment_trigger = no
			}
			#A "real" event if you're not receiving treatment
			#Nothing happens if you're already being treated for wounds
			trigger_event = {
				id = health.0102
				days = { 2 3 }
			}
		}
		else_if = {
			limit = {
				has_trait_rank = {
					trait = wounded
					rank = 3
				}
				has_recent_wound_treatment_trigger = no
			}
			#A "real" event if you're not receiving treatment
			#Nothing happens if you're already being treated for wounds
			trigger_event = {
				id = health.0104
				days = { 2 3 }
			}

			#Epilepsy risk
			epilepsy_brain_trauma_risk_effect = { CHANCE = 5 }
		}
	}

	# To stop the game from complaining about unused character flags since we only specifically check
	# the treatment reason for risk of further or infection
	if = {
		limit = {
			exists = flag:$REASON$
		}
	}
}

# Wound two times in a row, risk of death
increase_wounds_two_times_effect = {
	if = {
		limit = {
			has_trait_rank = {
				trait = wounded
				rank < 2 #the vanilla effect to wound once checks for < 3
			}
		}
		increase_wounds_two_times_no_death_effect = { REASON = $REASON$ }
	}
	else_if = { #Using an if because this needs to never go wrong
		limit = {
			has_trait_rank = {
				trait = wounded
				rank >= 2 #the vanilla effect to kill checks for 3
			}
		}
		death = {
			death_reason = death_$REASON$
		}
	}
}

# Inflict the Blood Price on someone - blood
# Need a prisoner and an imprisoner
inflict_bloodprice = {
	$PRISONER$ = {
		if = { # No reason? Small health penalty
			limit = {
				$JAILOR$ = {
					NOR = {
						has_imprisonment_reason = $PRISONER$
						has_execute_reason = $PRISONER$
					}
				}
			}
			if = {
				limit = {
					$JAILOR$ = root
				}
				custom_tooltip = {
					text = extract_blood_price_effect_no_reason_tooltip
					add_character_modifier = {
						modifier = small_blood_price_modifier
						years = 5
					}
				}
			}
			else = {
				add_character_modifier = {
					modifier = small_blood_price_modifier
					years = 5
				}
			}
		}
		else_if = { # Imprisonment reason? +1 Wound
			limit = { $JAILOR$ = { NOT = { has_execute_reason = $PRISONER$ } } }

			if = {
				limit = {
					$JAILOR$ = root
				}
				custom_tooltip = {
					text = extract_blood_price_effect_imprisonment_reason_tooltip
					increase_wounds_effect = { REASON = execution_blood_price }
				}
			}
			else = {
				increase_wounds_effect = { REASON = execution_blood_price }
			}
			
		}
		else = { # Execution reason? +2 Wound
			if = {
				limit = {
					$JAILOR$ = root
				}
				custom_tooltip = {
					text = extract_blood_price_effect_execution_reason_tooltip
					increase_wounds_two_times_effect = { REASON = execution_blood_price }
				}
			}
			else = {
				increase_wounds_two_times_effect = { REASON = execution_blood_price }
			}
		}

		consume_all_criminal_reasons_effect = {
			LIEGE = $JAILOR$
			CRIMINAL = $PRISONER$
		}

		$JAILOR$ = {
			add_prestige = miniscule_prestige_value
			if = {
				limit = { faith = { has_doctrine = tenet_legalism } }
				if = {
					limit = {
						$JAILOR$ = root
					}
					custom_tooltip = tenet_legalism_respecting_traditions_ct
					add_piety = miniscule_piety_value
				}
				else = {
					add_piety = miniscule_piety_value
				}	
			}
		}
		if = {
			limit = { NOT = { $PRISONER$ = { has_character_flag = blood_price_death }}}
			if = {
				limit = {
					$JAILOR$ = root
				}
				custom_tooltip = {
					text = extract_blood_price_effect_survival_release_tooltip
					release_from_prison = yes
				}
			}
			else = {
				release_from_prison = yes
			}
		}
		
		
		# clear all blood price flags. could probably have handled this with scope values but the old setup used flags and i cant be assed rn
		$PRISONER$ = {
			if = {
				limit = {
					has_character_flag = blood_price_wounded_1
				}
				remove_character_flag = blood_price_wounded_1
			}
			else_if = {
				limit = {
					has_character_flag = blood_price_wounded_2
				}
				remove_character_flag = blood_price_wounded_2
			}
			else_if = {
				limit = {
					has_character_flag = blood_price_wounded_3
				}
				remove_character_flag = blood_price_wounded_3
			}
			else_if = {
				limit = {
					has_character_flag = blood_price_death
				}
				remove_character_flag = blood_price_death
			}
			if = {
				limit = {
					has_character_flag = blood_price_wanted_pay_gold
				}
				remove_character_flag = blood_price_wanted_pay_gold
			}
			else_if = {
				limit = {
					has_character_flag = blood_price_wanted_pay_blood
				}
				remove_character_flag = blood_price_wanted_pay_blood
			}
			else_if = {
				limit = {
					has_character_flag = blood_price_wanted_freedom
				}
				remove_character_flag = blood_price_wanted_freedom
			}
			if = {
				limit = {
					has_variable = blood_price_gold_price
				}
				remove_variable = blood_price_gold_price
			}
		}

	}
}

# House of Reveries, new name effect
house_of_reveries_name_effect = {
	random_list = {
		1 = { give_nickname = nick_fire_bird }
		1 = { give_nickname = nick_silver_finger }
		1 = { give_nickname = nick_feather_moth }
		1 = { give_nickname = nick_candle_light }
		1 = { give_nickname = nick_bramble_bush }
		1 = { give_nickname = nick_lark_song }
		1 = { give_nickname = nick_sparkle_stone }
		1 = { give_nickname = nick_star_catcher }
		1 = { give_nickname = nick_word_weaver }
		1 = { give_nickname = nick_brush }
		1 = { give_nickname = nick_dancer }
		1 = { give_nickname = nick_wish }
		1 = { give_nickname = nick_clever }
		1 = { give_nickname = nick_swift }
		1 = { give_nickname = nick_enigma }
		1 = { give_nickname = nick_elegance }
		1 = { give_nickname = nick_dreamer }
		1 = { give_nickname = nick_alchemy }
		1 = { give_nickname = nick_illusion }
		1 = { give_nickname = nick_melody }
		1 = { give_nickname = nick_serenade }
		1 = { give_nickname = nick_juggler }
		1 = { give_nickname = nick_paint }
		1 = { give_nickname = nick_daring }
		1 = { give_nickname = nick_diversion }
		1 = { give_nickname = nick_forte }
		1 = { give_nickname = nick_minstrel }
		1 = { give_nickname = nick_echo }
		1 = { give_nickname = nick_euphony }
		1 = { give_nickname = nick_harmony }
		1 = { give_nickname = nick_cadence }
		1 = { give_nickname = nick_solace }
		1 = { give_nickname = nick_lullaby }
		1 = { give_nickname = nick_glisten }
		1 = { give_nickname = nick_dazzle }
		1 = { give_nickname = nick_rig }
		1 = { give_nickname = nick_zigzag }
		1 = { give_nickname = nick_vibrancy }
		1 = { give_nickname = nick_nimble }
		1 = { give_nickname = nick_jewelry }
		1 = { give_nickname = nick_sorrow_stealer }	
		1 = { give_nickname = nick_ringtail }	
		1 = { give_nickname = nick_laughter }	
		1 = { give_nickname = nick_mirror }	
		1 = { give_nickname = nick_stick }	
		1 = { give_nickname = nick_fey }	
		1 = { give_nickname = nick_many_toes }	
		1 = { give_nickname = nick_trick }	
		1 = { give_nickname = nick_handstand }
		1 = { give_nickname = nick_shadow_petal }
		1 = { give_nickname = nick_moon_spark }
		1 = { give_nickname = nick_quickstep }
		1 = { give_nickname = nick_twilight }
		1 = { give_nickname = nick_flicker }
		1 = { give_nickname = nick_glint }
		1 = { give_nickname = nick_riddle }
		1 = { give_nickname = nick_skipstone }
		1 = { give_nickname = nick_jest }
		1 = { give_nickname = nick_twister }
	}
}

house_of_reveries_remove_name_effect = {
	if = {
		limit = {
			OR = {
				has_nickname = nick_fire_bird
				has_nickname = nick_silver_finger	
				has_nickname = nick_feather_moth	
				has_nickname = nick_candle_light	
				has_nickname = nick_bramble_bush	
				has_nickname = nick_lark_song	
				has_nickname = nick_sparkle_stone	
				has_nickname = nick_star_catcher	
				has_nickname = nick_word_weaver
				has_nickname = nick_brush	
				has_nickname = nick_dancer	
				has_nickname = nick_wish	
				has_nickname = nick_clever	
				has_nickname = nick_swift	
				has_nickname = nick_enigma	
				has_nickname = nick_elegance	
				has_nickname = nick_dreamer
				has_nickname = nick_alchemy
				has_nickname = nick_illusion	
				has_nickname = nick_melody
				has_nickname = nick_serenade
				has_nickname = nick_juggler
				has_nickname = nick_paint
				has_nickname = nick_daring
				has_nickname = nick_diversion	
				has_nickname = nick_forte
				has_nickname = nick_minstrel	
				has_nickname = nick_echo
				has_nickname = nick_euphony
				has_nickname = nick_harmony
				has_nickname = nick_cadence	
				has_nickname = nick_solace 
				has_nickname = nick_lullaby
				has_nickname = nick_glisten
				has_nickname = nick_dazzle	
				has_nickname = nick_rig
				has_nickname = nick_zigzag 
				has_nickname = nick_vibrancy	
				has_nickname = nick_nimble 
				has_nickname = nick_jewelry
				has_nickname = nick_sorrow_stealer	
				has_nickname = nick_ringtail 
				has_nickname = nick_laughter 
				has_nickname = nick_mirror	
				has_nickname = nick_stick 
				has_nickname = nick_fey 
				has_nickname = nick_many_toes 
				has_nickname = nick_trick 
				has_nickname = nick_handstand
				has_nickname = nick_shadow_petal
		 		has_nickname = nick_moon_spark
				has_nickname = nick_quickstep
				has_nickname = nick_twilight
				has_nickname = nick_flicker
				has_nickname = nick_glint
				has_nickname = nick_riddle
				has_nickname = nick_skipstone
				has_nickname = nick_jest
				has_nickname = nick_twister
				}
			}
		remove_nickname = yes
	}
}

create_undead_thrall_effect = {
	$MASTER$ = { save_scope_as = master }
	$THRALL$ = { save_scope_as = thrall }

	set_variable = {
        name = thrall_prowess
		value = scope:thrall.prowess
    }

	create_character = {
        gender = scope:thrall
        age = scope:thrall.age
        random_traits = no
        save_scope_as = cloned_thrall
        culture = scope:thrall.culture
        faith = scope:master.faith
        diplomacy = 0
        martial = 0
        stewardship = 0
        learning = 0
        intrigue = 0
        prowess = var:thrall_prowess
        location = scope:master.capital_province
        template_character = scope:thrall
        trait = undead_character
		trait = education_martial_1
        dynasty = none

        after_creation = {	
			ek_character_setup_effect = yes	
            add_character_flag = summoned_undead
			set_variable = {
				name = undead_version_of
				value = scope:thrall
			}
			set_predetermined_decay_effect = { DECAY = 0.3 }
            set_sexuality = asexual
            copy_inheritable_appearance_from = scope:thrall
            change_first_name = { template_character = scope:thrall }
            add_opinion = {
                target = scope:master
                modifier = thrall_opinion
            }
			if = { 
                limit = { scope:master = { any_equipped_character_artifact = { has_artifact_modifier = bloodworm_helmet_modifier } } }
                scope:thrall = { add_prowess_skill = { 2 4 } }
            }
        }
    }

	hidden_effect = {
		scope:master = {
			create_character_memory = {
				type = claimed_thrall_memory
				participants = {
					thrall = scope:thrall
				}
			}
			add_courtier = scope:cloned_thrall
			add_hook = {
				type = loyalty_hook
				target = scope:cloned_thrall
			}  
		}

		scope:thrall = {
			create_character_memory = {
				type = became_thrall_memory
				participants = {
					master = scope:master
				}
			}
		}

		consume_all_criminal_reasons_effect = {
            LIEGE = scope:master
            CRIMINAL = scope:cloned_thrall
        }
	}
}

empower_thrall_arcana = {
	if = {
		limit = {
			has_character_flag = thrall_arcana
		}
		scope:undead_clone = {
			add_arcana_skill = { VALUE = "{ 10 20 }" }
		}
		remove_character_flag = thrall_arcana
	}
}

empower_thrall_prowess = {
	if = {
		limit = {
			has_character_flag = thrall_prowess
		}
		scope:undead_clone = {
			add_prowess_skill = { 10 20 }
		}
		remove_character_flag = thrall_prowess
	}
}

summon_undead_skeleton_effect = {
	$MASTER$ = { save_scope_as = master }

	random_list = {
		30 = {
			# Normal skeleton
			create_character = {
				template = undead_skeleton_template
				location = scope:master.location
				gender_female_chance = 50
				dynasty = none
				save_scope_as = undead_skeleton
				after_creation = {
					if = {
						limit = { exists = location.county }
						set_culture = location.county.culture
					}					
				}
			}			
		}
#EK TODO: change that into some more special decisions with the next lich/magic rework 
		10 = {
			# Nord Hero
			trigger = {
				any_realm_county = {
					any_county_province = {
						has_building = heroes_graveyard_01
					}
				}
			}
			create_character = {
				template = undead_skeleton_nord_hero_template
				location = scope:master.location
				dynasty = none
				save_scope_as = undead_skeleton
			}
		}
		10 = {
			# Redguard Hero
			trigger = {
				any_realm_county = {
					any_county_province = {
						has_building = motalion_necropolis_01
					}
				}
			}
			create_character = {
				template = undead_skeleton_redguard_hero_template
				location = scope:master.location
				dynasty = none
				save_scope_as = undead_skeleton
			}
		}
		10 = {
			# Khajiit Hero
			trigger = {
				any_realm_county = {
					any_county_province = {
						has_building = rimmen_necropolis_01
					}
				}
			}
			create_character = {
				template = undead_skeleton_khajiit_hero_template
				location = scope:master.location
				dynasty = none
				save_scope_as = undead_skeleton
			}
		}
	}
	
	scope:undead_skeleton = {
		add_character_flag = summoned_undead
		add_opinion = {
			target = scope:master
        	modifier = thrall_opinion
		}
		if = {
			limit = {
				any_realm_county = {
					any_county_province = {
						has_building = hidden_moon_crypts_01
					}
				}
			}
			add_prowess_skill = 2
		}
	}

	add_hook = {
		type = thrall_hook
		target = scope:undead_skeleton
	}
                           
	add_courtier = scope:undead_skeleton

	consume_all_criminal_reasons_effect = {
        LIEGE = scope:master
        CRIMINAL = scope:undead_skeleton
    }
}

steal_lifeforce_interaction_effect = {
	# reduce undead decay based on the victim's health
	if = {
		limit = { scope:recipient = { health <= fine_health }}
		scope:actor = {
			change_variable = {
				name = ek_undead_decay
				add = -0.05
			}
		}
	}
	else_if = {
		limit = { scope:recipient = { health <= good_health }}
		scope:actor = {
			change_variable = {
				name = ek_undead_decay
				add = -0.1
			}
		}
	}
	else_if = {
		limit = { scope:recipient = { health <= excellent_health }}
		scope:actor = {
			change_variable = {
				name = ek_undead_decay
				add = -0.15
			}
		}
	}
}

# Disrupt someones magic attunement, giving them Negative Arcana Affinity or removing their positive one
# Need a prisoner and an imprisoner

disrupt_arcana_effect = {
	scope:recipient = {
		add_trait_force_tooltip = disrupted

		add_character_modifier = {
			modifier = recently_disrupted
			years = 1
		}
		blind_castrated_disfigured_recipient_support_effect = yes
	}
}

#generate a three part name for summoned dragons
get_dragon_name = {
	save_scope_value_as = { name = max_length value = { integer_range = { min = 13 max = 16 } } } #13-16 feels good. longest named dragon is 14, location is 15

	# save length scopes for maths, need them to exist
	save_scope_value_as = { name = part_1_length value = 0 }
	save_scope_value_as = { name = part_2_length value = 0 }
	save_scope_value_as = { name = part_3_length value = 0 }

	# get part sizes and numbers
	get_dragon_name_part_size = { X = 1 }
	get_dragon_name_part_size = { X = 2 }
	get_dragon_name_part_size = { X = 3 }

	# if any are the same, get another
	# also some filtering
	while = { #part 1. 'the'/'of' dont tend to fit at the start
		limit = {
			OR = {
				AND = { #The
					scope:part_1_length = 3
					scope:part_1 = 5
				}
				AND = { #Of
					scope:part_1_length = 2
					scope:part_1 = 11
				}
			}
		}
		save_scope_value_as = { name = part_1_length value = 0 }
		get_dragon_name_part_size = { X = 1 }
	}
	while = { #part 2. cant be same as part 1
		limit = {
			scope:part_2_length = scope:part_1_length
			scope:part_2 = scope:part_1
		}
		save_scope_value_as = { name = part_2_length value = 0 }
		get_dragon_name_part_size = { X = 2 }
	}
	while = { #part 3. 'the'/'of' dont tend to fit at the end, cant be same as part 1 or 2
		limit = {
			OR = {
				AND = {
					scope:part_3_length = scope:part_1_length
					scope:part_3 = scope:part_1
				}
				AND = {
					scope:part_3_length = scope:part_2_length
					scope:part_3 = scope:part_2
				}
				AND = { #The
					scope:part_3_length = 3
					scope:part_3 = 5
				}
				AND = { #Of
					scope:part_3_length = 2
					scope:part_3 = 11
				}
			}
		}
		save_scope_value_as = { name = part_3_length value = 0 }
		get_dragon_name_part_size = { X = 3 }
	}

	# convert number to name flag with switch
	set_dragon_name_part = { X = 1 }
	set_dragon_name_part = { X = 2 }
	set_dragon_name_part = { X = 3 }
}
get_dragon_name_part_size = {
	save_scope_value_as = { #save current length
		name = current_length
		value = {
			value = scope:part_1_length
			add = scope:part_2_length
			add = scope:part_3_length
		}
	}

	random_list = {
		100 = {
			trigger = { #would any of the options go over the max length? add 2 as min part length
				save_temporary_scope_value_as = { name = trig_0 value = { value = scope:current_length add = 2 } }
				scope:max_length < scope:trig_0
			}
			save_scope_value_as = { name = part_$X$_length value = 0 }
			save_scope_value_as = { name = part_$X$ value = 0 }
		}
		14 = {
			trigger = { #would this option be below max length?
				save_temporary_scope_value_as = { name = trig_2 value = { value = scope:current_length add = 2 } }
				scope:max_length >= scope:trig_2
			}
			save_scope_value_as = { name = part_$X$_length value = 2 }
			save_scope_value_as = { name = part_$X$ value = { integer_range = { min = 1 max = 14 } } }
		}
		40 = {
			trigger = { #would this option be below max length?
				save_temporary_scope_value_as = { name = trig_3 value = { value = scope:current_length add = 3 } }
				scope:max_length >= scope:trig_3
			}
			save_scope_value_as = { name = part_$X$_length value = 3 }
			save_scope_value_as = { name = part_$X$ value = { integer_range = { min = 1 max = 40 } } }
		}
		41 = {
			trigger = { #would this option be below max length?
				save_temporary_scope_value_as = { name = trig_4 value = { value = scope:current_length add = 4 } }
				scope:max_length >= scope:trig_4
			}
			save_scope_value_as = { name = part_$X$_length value = 4 }
			save_scope_value_as = { name = part_$X$ value = { integer_range = { min = 1 max = 41 } } }
		}
		10 = {
			trigger = { #would this option be below max length?
				save_temporary_scope_value_as = { name = trig_5 value = { value = scope:current_length add = 5 } }
				scope:max_length >= scope:trig_5
			}
			save_scope_value_as = { name = part_$X$_length value = 5 }
			save_scope_value_as = { name = part_$X$ value = { integer_range = { min = 1 max = 10 } } }
		}
		6 = {
			trigger = { #would this option be below max length?
				save_temporary_scope_value_as = { name = trig_6 value = { value = scope:current_length add = 6 } }
				scope:max_length >= scope:trig_6
			}
			save_scope_value_as = { name = part_$X$_length value = 6 }
			save_scope_value_as = { name = part_$X$ value = { integer_range = { min = 1 max = 6 } } }
		}
		2 = {
			trigger = { #would this option be below max length?
				save_temporary_scope_value_as = { name = trig_7 value = { value = scope:current_length add = 7 } }
				scope:max_length >= scope:trig_7
			}
			save_scope_value_as = { name = part_$X$_length value = 7 }
			save_scope_value_as = { name = part_$X$ value = { integer_range = { min = 1 max = 2 } } }
		}
		1 = {
			trigger = { #would this option be below max length?
				save_temporary_scope_value_as = { name = trig_8 value = { value = scope:current_length add = 8 } }
				scope:max_length >= scope:trig_8
			}
			save_scope_value_as = { name = part_$X$_length value = 8 }
			save_scope_value_as = { name = part_$X$ value = { integer_range = { min = 1 max = 1 } } }
		}
	}
}
set_dragon_name_part = {
	switch = {
		trigger = scope:part_$X$_length

		0 = { set_dragon_name_flag = { X = $X$ NAME = dn_blank } } #Blank

		2 = {
			switch = {
				trigger = scope:part_$X$
				1 = { set_dragon_name_flag = { X = $X$ NAME = ag } } #Burn
				2 = { set_dragon_name_flag = { X = $X$ NAME = ah } } #Hunter
				3 = { set_dragon_name_flag = { X = $X$ NAME = al } } #Destroyer
				4 = { set_dragon_name_flag = { X = $X$ NAME = du } } #Devour
				5 = { set_dragon_name_flag = { X = $X$ NAME = fo } } #Frost
				6 = { set_dragon_name_flag = { X = $X$ NAME = in } } #Master
				7 = { set_dragon_name_flag = { X = $X$ NAME = lo } } #Deceive
				8 = { set_dragon_name_flag = { X = $X$ NAME = od } } #Snow
				9 = { set_dragon_name_flag = { X = $X$ NAME = on } } #Spirit
				10 = { set_dragon_name_flag = { X = $X$ NAME = qo } } #Lightning
				11 = { set_dragon_name_flag = { X = $X$ NAME = se } } #Of
				12 = { set_dragon_name_flag = { X = $X$ NAME = su } } #Air
				13 = { set_dragon_name_flag = { X = $X$ NAME = tu } } #Hammer
				14 = { set_dragon_name_flag = { X = $X$ NAME = ul } } #Eternity
			}
		}

		3 = {
			switch = {
				trigger = scope:part_$X$
				1 = { set_dragon_name_flag = { X = $X$ NAME = bah } } #Wrath
				2 = { set_dragon_name_flag = { X = $X$ NAME = dun } } #Grace
				3 = { set_dragon_name_flag = { X = $X$ NAME = dur } } #Curse
				4 = { set_dragon_name_flag = { X = $X$ NAME = fel } } #Feral
				5 = { set_dragon_name_flag = { X = $X$ NAME = fin } } #The
				6 = { set_dragon_name_flag = { X = $X$ NAME = fus } } #Force
				7 = { set_dragon_name_flag = { X = $X$ NAME = hah } } #Mind
				8 = { set_dragon_name_flag = { X = $X$ NAME = iiz } } #Ice
				9 = { set_dragon_name_flag = { X = $X$ NAME = jot } } #Maw
				10 = { set_dragon_name_flag = { X = $X$ NAME = kah } } #Pride
				11 = { set_dragon_name_flag = { X = $X$ NAME = kro } } #Sorcerer
				12 = { set_dragon_name_flag = { X = $X$ NAME = kun } } #Moonlight
				13 = { set_dragon_name_flag = { X = $X$ NAME = lok } } #Rise
				14 = { set_dragon_name_flag = { X = $X$ NAME = lot } } # Great
				15 = { set_dragon_name_flag = { X = $X$ NAME = luv } } #Tear
				16 = { set_dragon_name_flag = { X = $X$ NAME = mah } } #Fall/Fell
				17 = { set_dragon_name_flag = { X = $X$ NAME = mir } } #Allegiance
				18 = { set_dragon_name_flag = { X = $X$ NAME = mul } } #Strong
				19 = { set_dragon_name_flag = { X = $X$ NAME = nah } } #Fury
				20 = { set_dragon_name_flag = { X = $X$ NAME = nax } } #Cruelty
				21 = { set_dragon_name_flag = { X = $X$ NAME = neh } } #Never
				22 = { set_dragon_name_flag = { X = $X$ NAME = nin } } #Sting
				23 = { set_dragon_name_flag = { X = $X$ NAME = nir } } #Hunt
				24 = { set_dragon_name_flag = { X = $X$ NAME = nos } } #Strike
				25 = { set_dragon_name_flag = { X = $X$ NAME = qah } } #Armor
				26 = { set_dragon_name_flag = { X = $X$ NAME = rel } } #Domination
				27 = { set_dragon_name_flag = { X = $X$ NAME = rot } } #Word
				28 = { set_dragon_name_flag = { X = $X$ NAME = sah } } #Phantom
				29 = { set_dragon_name_flag = { X = $X$ NAME = sot } } #White
				30 = { set_dragon_name_flag = { X = $X$ NAME = sov } } #Shock
				31 = { set_dragon_name_flag = { X = $X$ NAME = sul } } #Day
				32 = { set_dragon_name_flag = { X = $X$ NAME = vah } } #Spring
				33 = { set_dragon_name_flag = { X = $X$ NAME = ved } } #Black
				34 = { set_dragon_name_flag = { X = $X$ NAME = vey } } #Cut
				35 = { set_dragon_name_flag = { X = $X$ NAME = vol } } #Horror
				36 = { set_dragon_name_flag = { X = $X$ NAME = vul } } #Dark
				37 = { set_dragon_name_flag = { X = $X$ NAME = vur } } #Valor
				38 = { set_dragon_name_flag = { X = $X$ NAME = yol } } #Fire
				39 = { set_dragon_name_flag = { X = $X$ NAME = zii } } #Spirit
				40 = { set_dragon_name_flag = { X = $X$ NAME = zin } } #Honor
			}
		}

		4 = {
			switch = {
				trigger = scope:part_$X$
				1 = { set_dragon_name_flag = { X = $X$ NAME = brii } } #Beauty
				2 = { set_dragon_name_flag = { X = $X$ NAME = brit } } #Beautiful
				3 = { set_dragon_name_flag = { X = $X$ NAME = daan } } #Doom
				4 = { set_dragon_name_flag = { X = $X$ NAME = drog } } #Lord
				5 = { set_dragon_name_flag = { X = $X$ NAME = du'ul } } #Crown
				6 = { set_dragon_name_flag = { X = $X$ NAME = feyn } } #Bane
				7 = { set_dragon_name_flag = { X = $X$ NAME = fiik } } #Mirror
				8 = { set_dragon_name_flag = { X = $X$ NAME = frin } } #Hot
				9 = { set_dragon_name_flag = { X = $X$ NAME = gaaf } } #Ghost
				10 = { set_dragon_name_flag = { X = $X$ NAME = gaar } } #Unleash/Release
				11 = { set_dragon_name_flag = { X = $X$ NAME = golz } } #Stone
				12 = { set_dragon_name_flag = { X = $X$ NAME = grah } } #Battle
				13 = { set_dragon_name_flag = { X = $X$ NAME = gron } } #Bind
				14 = { set_dragon_name_flag = { X = $X$ NAME = heyv } } #Duty
				15 = { set_dragon_name_flag = { X = $X$ NAME = jiid } } #Moon
				16 = { set_dragon_name_flag = { X = $X$ NAME = kaal } } #Champion
				17 = { set_dragon_name_flag = { X = $X$ NAME = kein } } #War
				18 = { set_dragon_name_flag = { X = $X$ NAME = kest } } #Tempest
				19 = { set_dragon_name_flag = { X = $X$ NAME = kren } } #Break
				20 = { set_dragon_name_flag = { X = $X$ NAME = krif } } #Fight
				21 = { set_dragon_name_flag = { X = $X$ NAME = krii } } #Kill
				22 = { set_dragon_name_flag = { X = $X$ NAME = kril } } #Brave
				23 = { set_dragon_name_flag = { X = $X$ NAME = krin } } #Courageous
				24 = { set_dragon_name_flag = { X = $X$ NAME = laas } } #Life
				25 = { set_dragon_name_flag = { X = $X$ NAME = liiv } } #Wither
				26 = { set_dragon_name_flag = { X = $X$ NAME = maar } } #Terror
				27 = { set_dragon_name_flag = { X = $X$ NAME = moro } } #Glory
				28 = { set_dragon_name_flag = { X = $X$ NAME = naak } } #Eat
				29 = { set_dragon_name_flag = { X = $X$ NAME = odus } } #Snowy
				30 = { set_dragon_name_flag = { X = $X$ NAME = onik } } #Wise
				31 = { set_dragon_name_flag = { X = $X$ NAME = paar } } #Ambition
				32 = { set_dragon_name_flag = { X = $X$ NAME = paaz } } #Fair
				33 = { set_dragon_name_flag = { X = $X$ NAME = qeth } } #Bone
				34 = { set_dragon_name_flag = { X = $X$ NAME = ruth } } #Rage
				35 = { set_dragon_name_flag = { X = $X$ NAME = thur } } #Overlord
				36 = { set_dragon_name_flag = { X = $X$ NAME = tiid } } #Time
				37 = { set_dragon_name_flag = { X = $X$ NAME = vaaz } } #Tear
				38 = { set_dragon_name_flag = { X = $X$ NAME = viin } } #Shine
				39 = { set_dragon_name_flag = { X = $X$ NAME = viir } } #Dying
				40 = { set_dragon_name_flag = { X = $X$ NAME = zind } } #Triumph
				41 = { set_dragon_name_flag = { X = $X$ NAME = zoor } } #Legend
			}
		}

		5 = {
			switch = {
				trigger = scope:part_$X$
				1 = { set_dragon_name_flag = { X = $X$ NAME = ahzid } } #Bitter
				2 = { set_dragon_name_flag = { X = $X$ NAME = hevno } } #Brutal
				3 = { set_dragon_name_flag = { X = $X$ NAME = kriid } } #Slayer
				4 = { set_dragon_name_flag = { X = $X$ NAME = munax } } #Cruel
				5 = { set_dragon_name_flag = { X = $X$ NAME = okaaz } } #Sea
				6 = { set_dragon_name_flag = { X = $X$ NAME = revak } } #Sacred
				7 = { set_dragon_name_flag = { X = $X$ NAME = strun } } #Storm
				8 = { set_dragon_name_flag = { X = $X$ NAME = viing } } #Wing
				9 = { set_dragon_name_flag = { X = $X$ NAME = vokun } } #Shadow
				10 = { set_dragon_name_flag = { X = $X$ NAME = yuvon } } #Gold/Golden
			}
		}

		6 = {
			switch = {
				trigger = scope:part_$X$
				1 = { set_dragon_name_flag = { X = $X$ NAME = boziik } } #Bold(ly)
				2 = { set_dragon_name_flag = { X = $X$ NAME = kinzon } } #Sharp
				3 = { set_dragon_name_flag = { X = $X$ NAME = nonvul } } #Noble
				4 = { set_dragon_name_flag = { X = $X$ NAME = rovaan } } #Wander
				5 = { set_dragon_name_flag = { X = $X$ NAME = sahrot } } #Mighty
				6 = { set_dragon_name_flag = { X = $X$ NAME = vahlok } } #Guardian
			}
		}

		7 = {
			switch = {
				trigger = scope:part_$X$
				1 = { set_dragon_name_flag = { X = $X$ NAME = bahlaan } } #Worthy
				2 = { set_dragon_name_flag = { X = $X$ NAME = kruziik } } #Ancient
			}
		}

		8 = {
			switch = {
				trigger = scope:part_$X$
				1 = { set_dragon_name_flag = { X = $X$ NAME = nahkriin } } #Vengeance
			}
		}
	}
}
set_dragon_name_flag = {
	if = { limit = { exists = scope:name$X$ scope:name$X$ = flag:$NAME$ } } #error suppression
	save_scope_value_as = { name = name$X$ value = flag:$NAME$ }
}

### Daedric whispers - Give the right combo of trait and daedra
# Flag
set_combo_trait_daedra_flag = {
	add_character_flag = stress_$TRAIT$_$DAEDRA$
}

### Might Makes Right
# Laws - Check if a law is still good even after you lose a level of Fame or Devotion
# Current scope must be the character
might_makes_right_update_law_fame_devotion = {
	if = {
		limit = {
			has_realm_law = crown_authority_3
			NOT = { culture = { has_innovation = innovation_royal_prerogative } }
			NOT = { might_makes_right_requires = { AMOUNT = 5 FLAG = flag:law } }
		}
		add_realm_law_skip_effects = crown_authority_2
	}
	if = {
		limit = {
			has_realm_law = crown_authority_2
			NOT = { culture = { has_innovation = innovation_royal_prerogative } }
			NOT = { might_makes_right_requires = { AMOUNT = 4 FLAG = flag:law } }
		}
		add_realm_law_skip_effects = crown_authority_1
	}
	if = {
		limit = {
			has_realm_law = crown_authority_1
			NOT = { culture = { has_innovation = innovation_plenary_assemblies } }
			NOT = { might_makes_right_requires = { AMOUNT = 3 FLAG = flag:law } }
		}
		add_realm_law_skip_effects = crown_authority_0
	}
}

### Get the square root of a value
# Need to set local_var:param, set_local_variable = { name = param value = 100 }
# get_sqrt = {
# set_local_variable = { name = x value = local_var:param }
# set_local_variable = { name = y value = 1 }
# set_local_variable = { name = e value = 0.001 }
# set_local_variable = { name = condition value = { value = local_var:x subtract = local_var:y } }
# # add_prestige = 1
# # add_piety = local_var:x
# while = {
# limit = { local_var:condition > local_var:e }
# set_local_variable = { name = x value = { value = local_var:x add = local_var:y divide = 2 } }
# set_local_variable = { name = y value = { value = local_var:x divide = local_var:param } }
# set_local_variable = { name = condition value = { value = local_var:x subtract = local_var:y } }
# }
# add_piety = local_var:x
# add_piety = local_var:y
# add_piety = local_var:condition
# set_local_variable = { name = result value = local_var:x }
# }
# Calculate it one by one, not optimal but hey, worst case (for now) is to start at like 1000
get_sqrt = {
	get_sqrt_integer = yes
	get_sqrt_precise = yes
}

get_sqrt_integer = { # Rough estimate
	set_local_variable = { name = x value = 1 }
	set_local_variable = { name = x_squared value = { value = local_var:x multiply = local_var:x } }
	while = {
		limit = { local_var:param > local_var:x_squared }

		set_local_variable = { name = x value = { value = local_var:x add = 1 } }
		set_local_variable = { name = x_squared value = { value = local_var:x multiply = local_var:x } }
	}
	set_local_variable = { name = result value = local_var:x }
}

get_sqrt_precise = { # Much more precise estimate, but we need to know where to start (we know the square root is between x and x-1
	set_local_variable = { name = x value = local_var:result }
	set_local_variable = { name = x_squared value = { value = local_var:x multiply = local_var:x } }
	while = { # We work backwards
		limit = { local_var:x_squared > local_var:param }

		set_local_variable = { name = x value = { value = local_var:x subtract = 0.001 } }
		set_local_variable = { name = x_squared value = { value = local_var:x multiply = local_var:x } }
	}
	set_local_variable = { name = result value = local_var:x }
}

### Orsinium Flavor
update_orsinium_mountain_orc_advantage = {
	if = {
		limit = {
			title:k_orsinium = {
				is_title_created = yes
				any_in_de_jure_hierarchy = { is_titular = no } # Has at least one de jure vassal
			}
		}

		### Orsinium Defense Squad: +20 advantage, -5 for each de Jure duchy in Orsinium
		title:k_orsinium = {
			set_variable = {
				name = nb_orsinium_mountain_orc_advantage
				value = 5
			}

			every_in_de_jure_hierarchy = {
				limit = { tier = tier_duchy }
				title:k_orsinium = {
					change_variable = {
						name = nb_orsinium_mountain_orc_advantage
						subtract = 1
					}
				}
			}

			if = {
				limit = { var:nb_orsinium_mountain_orc_advantage > 0 }
				every_in_de_facto_hierarchy = {
					limit = {
						tier = tier_barony
						save_temporary_scope_as = current_prov
						title:k_orsinium = { is_de_jure_liege_or_above_target = scope:current_prov }
					}
					title_province = {
						set_while_counter_variable_effect = yes
						while = {
							limit = {
								var:while_counter < title:k_orsinium.var:nb_orsinium_mountain_orc_advantage
							}
							add_province_modifier = orsinium_mountain_orc_advantage
							increase_while_counter_variable_effect = yes
						}
						remove_while_counter_variable_effect = yes
					}
				}
			}
		}
	}
}

# Update the vassal obligations
# Need scope:vassal and scope:liege
vassal_update_obligations_type = {
	if = {
		limit = { vassal_should_use_obligation = { OBLIGATION_LEVEL = flag:prowess } }
		vassal_contract_set_obligation_level = {
			type = vassal_contribution_group level = 5
		}
	}
	else_if = {
		limit = { vassal_should_use_obligation = { OBLIGATION_LEVEL = flag:arcana } }
		vassal_contract_set_obligation_level = {
			type = vassal_contribution_group level = 4
		}
	}
	else_if = {
		limit = { vassal_should_use_obligation = { OBLIGATION_LEVEL = flag:fame } }
		vassal_contract_set_obligation_level = {
			type = vassal_contribution_group level = 3
		}
	}
	else_if = {
		limit = { vassal_should_use_obligation = { OBLIGATION_LEVEL = flag:devotion } }
		vassal_contract_set_obligation_level = {
			type = vassal_contribution_group level = 2
		}
	}
	else = {
		vassal_contract_set_obligation_level = {
			type = vassal_contribution_group level = 1
		}
	}
}

# Removes your education trait
remove_education_effect = {
	remove_trait = education_diplomacy_1
	remove_trait = education_diplomacy_2
	remove_trait = education_diplomacy_3
	remove_trait = education_diplomacy_4
	remove_trait = education_diplomacy_5
	remove_trait = education_martial_1
	remove_trait = education_martial_2
	remove_trait = education_martial_3
	remove_trait = education_martial_4
	remove_trait = education_martial_5
	remove_trait = education_stewardship_1
	remove_trait = education_stewardship_2
	remove_trait = education_stewardship_3
	remove_trait = education_stewardship_4
	remove_trait = education_stewardship_5
	remove_trait = education_intrigue_1
	remove_trait = education_intrigue_2
	remove_trait = education_intrigue_3
	remove_trait = education_intrigue_4
	remove_trait = education_intrigue_5
	remove_trait = education_learning_1
	remove_trait = education_learning_2
	remove_trait = education_learning_3
	remove_trait = education_learning_4
	remove_trait = education_learning_5
}

### CULTURE: DEAD OR ALIVE
# Revive a culture, make it go from dead to alive
culture_become_alive_effect = {
	add_to_global_variable_list = {
		name = culture_is_alive
		target = this
	}
	if = {
		limit = { has_innovation = innovation_dead_culture }
		remove_innovation = innovation_dead_culture
	}
	if = {
		limit = { has_innovation = innovation_extinct_race }
		remove_innovation = innovation_extinct_race
	}
}

# Kill a culture
culture_become_dead_effect = {
	remove_list_global_variable = {
		name = culture_is_alive
		target = this
	}
	if = {
		limit = { 
			NOR = { 
				has_innovation = innovation_dead_culture 
				has_innovation = innovation_daedric_race # let's make an exception for cultures that aren't even meant to be in Mundus to begin with
				has_innovation = innovation_extinct_race # some peoples are so dead that they shouldn't even be considered a Dead Culture, but rather an Extinct Race
			}
		}	
		add_innovation = innovation_dead_culture
	}
}

### EK NOTE: Mentions magocracy, but actually unlocked by a cultural tradition/innovation
# Update the RANK_magocracy_mage_bonus_modifier
update_magocracy_mage_bonus_modifier = {
	remove_character_modifier = count_magocracy_mage_bonus_modifier
	remove_character_modifier = duke_magocracy_mage_bonus_modifier
	remove_character_modifier = king_magocracy_mage_bonus_modifier
	remove_character_modifier = emperor_magocracy_mage_bonus_modifier
	
	if = {
		limit = { 
			culture = {
				OR = {
					has_cultural_parameter = rank_gives_bonus_to_mage_maa 
					has_cultural_parameter = sorcerer_kings_tradition
				}
			} 
		}

		if = {
			limit = { highest_held_title_tier = tier_county }
			add_character_modifier = count_magocracy_mage_bonus_modifier
		}
		else_if = {
			limit = { highest_held_title_tier = tier_duchy }
			add_character_modifier = duke_magocracy_mage_bonus_modifier
		}
		else_if = {
			limit = { highest_held_title_tier = tier_kingdom }
			add_character_modifier = king_magocracy_mage_bonus_modifier
		}
		else_if = {
			limit = { highest_held_title_tier = tier_empire }
			add_character_modifier = emperor_magocracy_mage_bonus_modifier
		}
	}
}

### Tribal ruler level of fame modifier
update_tribal_ruler_prestige_level = {
	# First, we clear the modifiers
	if = {
		limit = {
			OR = {
				has_character_modifier = tribal_expected_level_of_fame_below_5
				has_character_modifier = tribal_expected_level_of_fame_below_4
				has_character_modifier = tribal_expected_level_of_fame_below_3
				has_character_modifier = tribal_expected_level_of_fame_below_2
				has_character_modifier = tribal_expected_level_of_fame_below_1
				
				has_character_modifier = tribal_expected_level_of_fame_above_5
				has_character_modifier = tribal_expected_level_of_fame_above_4
				has_character_modifier = tribal_expected_level_of_fame_above_3
				has_character_modifier = tribal_expected_level_of_fame_above_2
				has_character_modifier = tribal_expected_level_of_fame_above_1
			}
		}
		if = {
			limit = { has_character_modifier = tribal_expected_level_of_fame_below_5 }
			remove_character_modifier = tribal_expected_level_of_fame_below_5
		}
		else_if = {
			limit = { has_character_modifier = tribal_expected_level_of_fame_below_4 }
			remove_character_modifier = tribal_expected_level_of_fame_below_4
		}
		else_if = {
			limit = { has_character_modifier = tribal_expected_level_of_fame_below_3 }
			remove_character_modifier = tribal_expected_level_of_fame_below_3
		}
		else_if = {
			limit = { has_character_modifier = tribal_expected_level_of_fame_below_2 }
			remove_character_modifier = tribal_expected_level_of_fame_below_2
		}
		else_if = {
			limit = { has_character_modifier = tribal_expected_level_of_fame_below_1 }
			remove_character_modifier = tribal_expected_level_of_fame_below_1
		}
		else_if = {
			limit = { has_character_modifier = tribal_expected_level_of_fame_above_5 }
			remove_character_modifier = tribal_expected_level_of_fame_above_5
		}
		else_if = {
			limit = { has_character_modifier = tribal_expected_level_of_fame_above_4 }
			remove_character_modifier = tribal_expected_level_of_fame_above_4
		}
		else_if = {
			limit = { has_character_modifier = tribal_expected_level_of_fame_above_3 }
			remove_character_modifier = tribal_expected_level_of_fame_above_3
		}
		else_if = {
			limit = { has_character_modifier = tribal_expected_level_of_fame_above_2 }
			remove_character_modifier = tribal_expected_level_of_fame_above_2
		}
		else_if = {
			limit = { has_character_modifier = tribal_expected_level_of_fame_above_1 }
			remove_character_modifier = tribal_expected_level_of_fame_above_1
		}
	}
	
	if = {
		limit = { government_has_flag = government_is_tribal }
		
		save_scope_value_as = { name = current_prestige_level value = current_prestige_level }
		save_scope_value_as = { name = expected_prestige_level value = expected_prestige_level }
		
		# If tribal_ruler_prestige_level < tribal_ruler_expected_prestige_level, we get the penalties
		if = {
			limit = { scope:current_prestige_level <= { value = scope:expected_prestige_level subtract = 5 } }
			add_character_modifier = tribal_expected_level_of_fame_below_5
		}
		else_if = {
			limit = { scope:current_prestige_level == { value = scope:expected_prestige_level subtract = 4 } }
			add_character_modifier = tribal_expected_level_of_fame_below_4
		}
		else_if = {
			limit = { scope:current_prestige_level == { value = scope:expected_prestige_level subtract = 3 } }
			add_character_modifier = tribal_expected_level_of_fame_below_3
		}
		else_if = {
			limit = { scope:current_prestige_level == { value = scope:expected_prestige_level subtract = 2 } }
			add_character_modifier = tribal_expected_level_of_fame_below_2
		}
		else_if = {
			limit = { scope:current_prestige_level == { value = scope:expected_prestige_level subtract = 1 } }
			add_character_modifier = tribal_expected_level_of_fame_below_1
		}
		# Otherwise, we get the bonuses
		if = {
			limit = { scope:current_prestige_level >= { value = scope:expected_prestige_level add = 5 } }
			add_character_modifier = tribal_expected_level_of_fame_above_5
		}
		else_if = {
			limit = { scope:current_prestige_level == { value = scope:expected_prestige_level add = 4 } }
			add_character_modifier = tribal_expected_level_of_fame_above_4
		}
		else_if = {
			limit = { scope:current_prestige_level == { value = scope:expected_prestige_level add = 3 } }
			add_character_modifier = tribal_expected_level_of_fame_above_3
		}
		else_if = {
			limit = { scope:current_prestige_level == { value = scope:expected_prestige_level add = 2 } }
			add_character_modifier = tribal_expected_level_of_fame_above_2
		}
		else_if = {
			limit = { scope:current_prestige_level == { value = scope:expected_prestige_level add = 1 } }
			add_character_modifier = tribal_expected_level_of_fame_above_1
		}
		### EK NOTE: Fancy that, an actual use case for == - He9
	}
}

### Hierocracies, lower the CA if the ruler doesn't control enough land of their faith
hierocracy_lower_ca_land_same_faith_held = {
	if = {
		limit = {
			has_realm_law = crown_authority_3
			NOT = {
				custom_description = {
					text = high_enough_ratio_nb_provinces_same_faith_held_provinces_same_faith
					subject = root
					value = 75
					ratio_nb_provinces_same_faith_held_provinces_same_faith >= 75
				}
			}
		}
		add_realm_law_skip_effects = crown_authority_2
	}
	if = {
		limit = {
			has_realm_law = crown_authority_2
			NOT = {
				custom_description = {
					text = high_enough_ratio_nb_provinces_same_faith_held_provinces_same_faith
					subject = root
					value = 50
					ratio_nb_provinces_same_faith_held_provinces_same_faith >= 50
				}
			}
		}
		add_realm_law_skip_effects = crown_authority_1
	}
	if = {
		limit = {
			has_realm_law = crown_authority_1
			NOT = {
				custom_description = {
					text = high_enough_ratio_nb_provinces_same_faith_held_provinces_same_faith
					subject = root
					value = 25
					ratio_nb_provinces_same_faith_held_provinces_same_faith >= 25
				}
			}
		}
		add_realm_law_skip_effects = crown_authority_0
	}
}

### Tribal holdings get a tax and levies bonus depending on the nb of free holdings in the province
# Needs to be called from a County-level landed title
tribal_holding_get_free_holding_modifier = {
	# Clean the modifiers
	if = {
		limit = {
			any_county_province = {
				OR = {
					has_province_modifier = tribal_holding_1_open_holding
					has_province_modifier = tribal_holding_2_open_holding
					has_province_modifier = tribal_holding_3_open_holding
					has_province_modifier = tribal_holding_4_open_holding
					has_province_modifier = tribal_holding_5_open_holding
					has_province_modifier = tribal_holding_6_open_holding
					has_province_modifier = tribal_holding_7_open_holding
					has_province_modifier = tribal_holding_8_open_holding
					has_province_modifier = tribal_holding_9_open_holding
				}
			}
		}
		every_county_province = {
			limit = {
				OR = {
					has_province_modifier = tribal_holding_1_open_holding
					has_province_modifier = tribal_holding_2_open_holding
					has_province_modifier = tribal_holding_3_open_holding
					has_province_modifier = tribal_holding_4_open_holding
					has_province_modifier = tribal_holding_5_open_holding
					has_province_modifier = tribal_holding_6_open_holding
					has_province_modifier = tribal_holding_7_open_holding
					has_province_modifier = tribal_holding_8_open_holding
					has_province_modifier = tribal_holding_9_open_holding
				}
			}
			if = {
				limit = { has_province_modifier = tribal_holding_1_open_holding }
				remove_province_modifier = tribal_holding_1_open_holding
			}
			else_if = {
				limit = { has_province_modifier = tribal_holding_2_open_holding }
				remove_province_modifier = tribal_holding_2_open_holding
			}
			else_if = {
				limit = { has_province_modifier = tribal_holding_3_open_holding }
				remove_province_modifier = tribal_holding_3_open_holding
			}
			else_if = {
				limit = { has_province_modifier = tribal_holding_4_open_holding }
				remove_province_modifier = tribal_holding_4_open_holding
			}
			else_if = {
				limit = { has_province_modifier = tribal_holding_5_open_holding }
				remove_province_modifier = tribal_holding_5_open_holding
			}
			else_if = {
				limit = { has_province_modifier = tribal_holding_6_open_holding }
				remove_province_modifier = tribal_holding_6_open_holding
			}
			else_if = {
				limit = { has_province_modifier = tribal_holding_7_open_holding }
				remove_province_modifier = tribal_holding_7_open_holding
			}
			else_if = {
				limit = { has_province_modifier = tribal_holding_8_open_holding }
				remove_province_modifier = tribal_holding_8_open_holding
			}
			else_if = {
				limit = { has_province_modifier = tribal_holding_9_open_holding }
				remove_province_modifier = tribal_holding_9_open_holding
			}
		}
	}
	
	# Apply the new one
	if = {
		limit = { any_county_province = { has_holding_type = tribal_holding } }
		
		every_county_province = {
			limit  = { has_holding_type = tribal_holding }
			save_scope_as = tribal_province
			set_variable = { name = free_holdings value = 0 }
		}
	
		every_county_province = {
			limit = {
				NOR = {
					has_holding_type = castle_holding
					has_holding_type = tribal_holding
					has_holding_type = city_holding
					has_holding_type = church_holding
					has_holding_type = academy_holding
					has_holding_type = hist_holding
				}
			}
			scope:tribal_province = { change_variable = { name = free_holdings add = 1 } }
		}
		
		if = {
			limit = { scope:tribal_province = { var:free_holdings > 0 } }
			if = {
				limit = { scope:tribal_province = { var:free_holdings = 1 } }
				scope:tribal_province = { add_province_modifier = tribal_holding_1_open_holding }
			}
			else_if = {
				limit = { scope:tribal_province = { var:free_holdings = 2 } }
				scope:tribal_province = { add_province_modifier = tribal_holding_2_open_holding }
			}
			else_if = {
				limit = { scope:tribal_province = { var:free_holdings = 3 } }
				scope:tribal_province = { add_province_modifier = tribal_holding_3_open_holding }
			}
			else_if = {
				limit = { scope:tribal_province = { var:free_holdings = 4 } }
				scope:tribal_province = { add_province_modifier = tribal_holding_4_open_holding }
			}
			else_if = {
				limit = { scope:tribal_province = { var:free_holdings = 5 } }
				scope:tribal_province = { add_province_modifier = tribal_holding_5_open_holding }
			}
			else_if = {
				limit = { scope:tribal_province = { var:free_holdings = 6 } }
				scope:tribal_province = { add_province_modifier = tribal_holding_6_open_holding }
			}
			else_if = {
				limit = { scope:tribal_province = { var:free_holdings = 7 } }
				scope:tribal_province = { add_province_modifier = tribal_holding_7_open_holding }
			}
			else_if = {
				limit = { scope:tribal_province = { var:free_holdings = 8 } }
				scope:tribal_province = { add_province_modifier = tribal_holding_8_open_holding }
			}
			else_if = {
				limit = { scope:tribal_province = { var:free_holdings >= 9 } }
				scope:tribal_province = { add_province_modifier = tribal_holding_9_open_holding }
			}
		}
	}
}

# fake_duel = { #tests skill against given value
# 	skill = arcana
# 	value = 10
# 	target = this
# }

# fake_duel = { tests skill against target's skill
# 	skill = arcana
# 	value = 0
# 	target = scope:character
# }

fake_duel = {
	if = {
		limit = { this = $target$ }
		custom_description_no_bullet = {
			text = $skill$_duel
			save_scope_value_as = {
				name = fake_duel_value
				value = {
					value = $skill$
					subtract = $value$
				}
			}
		}
	}
	else_if = {
		limit = { exists = $target$ }
		custom_description_no_bullet = {
			text = $skill$_duel_against
			object = $target$
			save_scope_value_as = {
				name = fake_duel_value
				value = {
					value = $skill$
					subtract = $target$.$skill$
				}
			}
		}
	}
	#else debug - incorrectly set target, should be no or character
}

ek_remember_recent_conquest_victory_effect = {
	if = {
		limit = {
			exists = scope:defender
		}
		set_variable = {
			name = major_war_victory
			value = scope:defender
			years = 5
		}
	}
}

ek_get_lowest_player_skill_effect = {
	random_list = {
		1 = {
			trigger = {
				AND = {
					diplomacy <= martial 
					diplomacy <= stewardship
					diplomacy <= intrigue
					diplomacy <= learning
					diplomacy <= prowess
					diplomacy <= arcana
				}
			}
			save_scope_value_as = {
				name = lowest_player_skill
				value = flag:diplomacy
			}
		}
		1 = {
			trigger = {
				AND = {
					martial <= diplomacy
					martial <= stewardship
					martial <= intrigue
					martial <= learning
					martial <= prowess
					martial <= arcana
				}
			}
			save_scope_value_as = {
				name = lowest_player_skill
				value = flag:martial
			}
		}
		1 = {
			trigger = {
				AND = {
					stewardship <= diplomacy
					stewardship <= martial
					stewardship <= intrigue
					stewardship <= learning
					stewardship <= prowess
					stewardship <= arcana
				}
			}
			save_scope_value_as = {
				name = lowest_player_skill
				value = flag:stewardship
			}
		}
		1 = {
			trigger = {
				AND = {
					intrigue <= diplomacy
					intrigue <= martial
					intrigue <= stewardship
					intrigue <= learning
					intrigue <= prowess
					intrigue <= arcana
				}
			}
			save_scope_value_as = {
				name = lowest_player_skill
				value = flag:intrigue
			}
		}
		1 = {
			trigger = {
				AND = {
					learning <= diplomacy
					learning <= martial
					learning <= stewardship
					learning <= intrigue
					learning <= prowess
					learning <= arcana
				}
			}
			save_scope_value_as = {
				name = lowest_player_skill
				value = flag:learning
			}
		}
		1 = {
			trigger = {
				AND = {
					prowess <= diplomacy
					prowess <= martial
					prowess <= stewardship
					prowess <= intrigue
					prowess <= learning
					prowess <= arcana
				}
			}
			save_scope_value_as = {
				name = lowest_player_skill
				value = flag:prowess
			}
		}
		1 = {
			trigger = {
				AND = {
					arcana <= diplomacy
					arcana <= martial
					arcana <= stewardship
					arcana <= intrigue
					arcana <= learning
					arcana <= prowess
				}
			}
			save_scope_value_as = {
				name = lowest_player_skill
				value = flag:arcana
			}
		}
	}
}

ek_get_highest_player_skill_effect = {
	random_list = {
		1 = {
			trigger = {
				AND = {
					diplomacy >= martial 
					diplomacy >= stewardship
					diplomacy >= intrigue
					diplomacy >= learning
					diplomacy >= prowess
					diplomacy >= arcana
				}
			}
			save_scope_value_as = {
				name = highest_player_skill
				value = flag:diplomacy
			}
		}
		1 = {
			trigger = {
				AND = {
					martial >= diplomacy
					martial >= stewardship
					martial >= intrigue
					martial >= learning
					martial >= prowess
					martial >= arcana
				}
			}
			save_scope_value_as = {
				name = highest_player_skill
				value = flag:martial
			}
		}
		1 = {
			trigger = {
				AND = {
					stewardship >= diplomacy
					stewardship >= martial
					stewardship >= intrigue
					stewardship >= learning
					stewardship >= prowess
					stewardship >= arcana
				}
			}
			save_scope_value_as = {
				name = highest_player_skill
				value = flag:stewardship
			}
		}
		1 = {
			trigger = {
				AND = {
					intrigue >= diplomacy
					intrigue >= martial
					intrigue >= stewardship
					intrigue >= learning
					intrigue >= prowess
					intrigue >= arcana
				}
			}
			save_scope_value_as = {
				name = highest_player_skill
				value = flag:intrigue
			}
		}
		1 = {
			trigger = {
				AND = {
					learning >= diplomacy
					learning >= martial
					learning >= stewardship
					learning >= intrigue
					learning >= prowess
					learning >= arcana
				}
			}
			save_scope_value_as = {
				name = highest_player_skill
				value = flag:learning
			}
		}
		1 = {
			trigger = {
				AND = {
					prowess >= diplomacy
					prowess >= martial
					prowess >= stewardship
					prowess >= intrigue
					prowess >= learning
					prowess >= arcana
				}
			}
			save_scope_value_as = {
				name = highest_player_skill
				value = flag:prowess
			}
		}
		1 = {
			trigger = {
				AND = {
					arcana >= diplomacy
					arcana >= martial
					arcana >= stewardship
					arcana >= intrigue
					arcana >= learning
					arcana >= prowess
				}
			}
			save_scope_value_as = {
				name = highest_player_skill
				value = flag:arcana
			}
		}
	}
}

ek_rank_up_education_effect = {
	if = {
		limit = { has_education_rank_4_trigger = no }
		if = {
			limit = { has_trait = education_diplomacy }
			change_trait_rank = {
				trait = education_diplomacy
				rank = 1
			}
		}
		else_if = {
			limit = { has_trait = education_martial }
			change_trait_rank = {
				trait = education_martial
				rank = 1
			}
		}
		else_if = {
			limit = { has_trait = education_stewardship }
			change_trait_rank = {
				trait = education_stewardship
				rank = 1
			}
		}
		else_if = {
			limit = { has_trait = education_intrigue }
			change_trait_rank = {
				trait = education_intrigue
				rank = 1
			}
		}
		else_if = {
			limit = { has_trait = education_learning }
			change_trait_rank = {
				trait = education_learning
				rank = 1
			}
		}
		else_if = {
			limit = { has_trait = education_martial_prowess }
			change_trait_rank = {
				trait = education_martial_prowess
				rank = 1
			}
		}
		else_if = {
			limit = { has_trait = education_magic }
			change_trait_rank = {
				trait = education_magic
				rank = 1
			}
		}
	}
}

clone_sexuality = {
	if = {
		limit = {
		scope:recipient = { has_sexuality = bisexual }
		}
		scope:clone = {
			set_sexuality = bisexual
		}
	}
	if = {
		limit = {
			scope:recipient = {has_sexuality = homosexual}
		}
		scope:clone = {
			set_sexuality = homosexual
		}
	}
	if = {
		limit = {
			scope:recipient = {has_sexuality = heterosexual}
		}
		scope:clone = {
			set_sexuality = heterosexual
		}
	}
	if = {
		limit = {
			scope:recipient = {has_sexuality = asexual}
		}
		scope:clone = {
			set_sexuality = asexual
		}
	}
}

remove_health_traits = {

	#There are 32 health traits

	if = {
		limit = {
			scope:recipient = { has_trait = pregnant }
		}
		scope:clone = {
			remove_trait = pregnant
		}
	}
	if = {
		limit = {
			scope:recipient = { has_trait = depressed_1 }
		}
		scope:clone = {
			remove_trait = depressed_1
		}
	}
	if = {
		limit = {
			scope:recipient = { has_trait = lunatic_1 }
		}
		scope:clone = {
			remove_trait = lunatic_1
		}
	}
	if = {
		limit = {
			scope:recipient = { has_trait = possessed_1 }
		}
		scope:clone = {
			remove_trait = possessed_1
		}
	}
	if = {
		limit = {
			scope:recipient = { has_trait = ill }
		}
		scope:clone = {
			remove_trait = ill
		}
	}
	if = {
		limit = {
			scope:recipient = { has_trait = pneumonic }
		}
		scope:clone = {
			remove_trait = pneumonic
		}
	}
	if = {
		limit = {
			scope:recipient = { has_trait = great_pox }
		}
		scope:clone = {
			remove_trait = great_pox
		}
	}
	if = {
		limit = {
			scope:recipient = { has_trait = early_great_pox }
		}
		scope:clone = {
			remove_trait = early_great_pox
		}
	}
	if = {
		limit = {
			scope:recipient = { has_trait = lovers_pox }
		}
		scope:clone = {
			remove_trait = lovers_pox
		}
	}
	if = {
		limit = {
			scope:recipient = { has_trait = leper }
		}
		scope:clone = {
			remove_trait = leper
		}
	}
	if = {
		limit = {
			scope:recipient = { has_trait = wounded_1 }
		}
		scope:clone = {
			remove_trait = wounded_1
		}
	}
	if = {
		limit = {
			scope:recipient = { has_trait = wounded_2 }
		}
		scope:clone = {
			remove_trait = wounded_2
		}
	}
	if = {
		limit = {
			scope:recipient = { has_trait = wounded_3 }
		}
		scope:clone = {
			remove_trait = wounded_3
		}
	}
	if = {
		limit = {
			scope:recipient = { has_trait = maimed }
		}
		scope:clone = {
			remove_trait = maimed
		}
	}
	if = {
		limit = {
			scope:recipient = { has_trait = one_eyed }
		}
		scope:clone = {
			remove_trait = one_eyed
		}
	}
	if = {
		limit = {
			scope:recipient = { has_trait = one_legged }
		}
		scope:clone = {
			remove_trait = one_legged
		}
	}
	if = {
		limit = {
			scope:recipient = { has_trait = disfigured }
		}
		scope:clone = {
			remove_trait = disfigured
		}
	}
	if = {
		limit = {
			scope:recipient = { has_trait = infirm }
		}
		scope:clone = {
			remove_trait = infirm
		}
	}
	if = {
		limit = {
			scope:recipient = { has_trait = incapable }
		}
		scope:clone = {
			remove_trait = incapable
		}
	}
	if = {
		limit = {
			scope:recipient = { has_trait = gout_ridden }
		}
		scope:clone = {
			remove_trait = gout_ridden
		}
	}
	if = {
		limit = {
			scope:recipient = { has_trait = consumption }
		}
		scope:clone = {
			remove_trait = consumption
		}
	}
	if = {
		limit = {
			scope:recipient = { has_trait = cancer }
		}
		scope:clone = {
			remove_trait = cancer
		}
	}
	if = {
		limit = {
			scope:recipient = { has_trait = typhus }
		}
		scope:clone = {
			remove_trait = typhus
		}
	}
	if = {
		limit = {
			scope:recipient = { has_trait = bubonic_plague }
		}
		scope:clone = {
			remove_trait = bubonic_plague
		}
	}
	if = {
        limit = { has_trait = sanies_lupinus }
        remove_trait = sanies_lupinus
    }
	if = {
		limit = { has_trait = sanguinare_vampiris }
		remove_trait = sanguinare_vampiris
	}
	if = {
		limit = {
			scope:recipient = { has_trait = smallpox }
		}
		scope:clone = {
			remove_trait = smallpox
		}
	}
	if = {
		limit = {
			scope:recipient = { has_trait = measles }
		}
		scope:clone = {
			remove_trait = measles
		}
	}
	if = {
		limit = {
			scope:recipient = { has_trait = dysentery }
		}
		scope:clone = {
			remove_trait = dysentery
		}
	}
	if = {
		limit = {
			scope:recipient = { has_trait = ergotism }
		}
		scope:clone = {
			remove_trait = ergotism
		}
	}
	if = {
		limit = {
			scope:recipient = { has_trait = sickly }
		}
		scope:clone = {
			remove_trait = sickly
		}
	}
	if = {
		limit = {
			scope:recipient = { has_trait = scarred }
		}
		scope:clone = {
			remove_trait = scarred
		}
	}
	if = {
		limit = {
			scope:recipient = { has_trait = eunuch_1 }
		}
		scope:clone = {
			remove_trait = eunuch_1
		}
	}
	if = {
		limit = {
			scope:recipient = { has_trait = beardless_eunuch }
		}
		scope:clone = {
			remove_trait = beardless_eunuch
		}
	}
	if = {
		limit = {
			scope:recipient = { has_trait = blind }
		}
		scope:clone = {
			remove_trait = blind
		}
	}	
}

clone_stats = {
	scope:clone = {
		add_diplomacy_skill = {value = scope:recipient.diplomacy subtract = diplomacy}
		add_martial_skill = {value = scope:recipient.martial subtract = martial}
		add_stewardship_skill = {value = scope:recipient.stewardship subtract = stewardship}
		add_intrigue_skill = {value = scope:recipient.intrigue subtract = intrigue}
		add_learning_skill = {value = scope:recipient.learning subtract = learning}
		add_prowess_skill = {value = scope:recipient.prowess subtract = prowess}
	}
}

contract_sanies_lupinus = {
	trigger_event = {
		id = ek_health.1001 
		days = { 7 14 }
	}
}

contract_sanguinare_vampiris = {
	trigger_event = {
		id = ek_health.1002
		days = { 7 14 }
	}
}


pay_short_term_gold_tribute_effect = {
	pay_short_term_gold = {
		gold = {
			value = $GOLD_VALUE$
		}
		target = scope:attacker
		yearly_income = yes
	}
}

## negotiate Alliance script effects

try_remove_beastfolk_alliance_opinion_effect = {
	if = {
		limit = {
			has_opinion_modifier = {
				modifier = beastfolk_negotiated_alliance_opinion
				target = $TARGET$
			}
		}
		remove_opinion = {
			modifier = beastfolk_negotiated_alliance_opinion
			target = $TARGET$
		}
	}
}			

take_torture_trophy_effect = {
	scope:actor = {
		save_scope_as = owner
		create_artifact = {
			name = artifact_torture_trophy_of_victim_name
			description = artifact_torture_trophy_of_victim_desc
			visuals = human_skull
			type = pedestal
			modifier = artifact_dread_baseline_add_1_modifier
			max_durability = 10
			save_scope_as = newly_created_artifact
		}
		if = {
			limit = {
				scope:recipient = {
					highest_held_title_tier = tier_duchy
				}
			}
			hidden_effect = {
				scope:newly_created_artifact = {
					remove_artifact_modifier = artifact_dread_baseline_add_1_modifier
					add_artifact_modifier = artifact_dread_baseline_add_2_modifier
				}
			}
		}
		else_if = {
			limit = {
				scope:recipient = {
					highest_held_title_tier = tier_kingdom
				}
			}
			hidden_effect = {
				scope:newly_created_artifact = {
					add_artifact_modifier = artifact_dread_decay_neg_mult_2_modifier
					add_artifact_modifier = artifact_monthly_prestige_4_modifier
					remove_artifact_modifier = artifact_dread_baseline_add_2_modifier
					add_artifact_modifier = artifact_dread_baseline_add_2_modifier
				}
			}
		}
		else_if = {
			limit = {
				scope:recipient = {
					highest_held_title_tier = tier_empire
				}
			}
			hidden_effect = {
				scope:newly_created_artifact = {
					add_artifact_modifier = artifact_dread_decay_neg_mult_3_modifier
					add_artifact_modifier = artifact_monthly_prestige_5_modifier
					remove_artifact_modifier = artifact_dread_baseline_add_2_modifier
					add_artifact_modifier = artifact_dread_baseline_add_3_modifier
				}
			}
		}
		else = {
			hidden_effect = {
				scope:newly_created_artifact = {
					add_artifact_modifier = artifact_dread_decay_neg_mult_1_modifier
					add_artifact_modifier = artifact_monthly_prestige_3_modifier
				}
			}
		}

		scope:newly_created_artifact = {
			save_scope_as = this_artifact
		}
		scope:recipient = {
			save_scope_as = old_owner
		}
		hidden_effect = {
			send_interface_toast = {	
				title = artifact.0012.t
				left_icon = scope:this_artifact
				right_icon = scope:old_owner
				custom_tooltip = artifact.0012.tooltip
			}
		}
	}
}

slave_character_culture_faith_effect = {
	# first we assign the slave an appropriate culture based on where they are located
	# these make some assumptions regarding which kinds of people are enslaved in each province without considering the culture of the slaver
	# but they're based on which slaver culture is present in any given region or likely to end up there (Altmer in Summerset is a given, but so is also Ayleids in Valenwood and Cyrodiil, Falmer in Skyrim, Dunmer in both Morrowind and Black Marsh etc)
	# but it works so
	
	### Summerset Isles ###
	if = {
		limit = {
			$LOCATION$ = {
				geographical_region = mundus_tamriel_summerset_isles
			}
		}
		random_list = {
			50 = { culture:goblin = { save_scope_as = slave_culture }} # Goblins are by far the most common slave to the Altmer
			15 = { culture:mountain_orc = { save_scope_as = slave_culture }} # Orcs aren't very well regarded
			7 = { culture:bosmer = { save_scope_as = slave_culture }} # Bosmer have the unfortunate honour of being the closest neighbour to Alinor, and Boiche are the closest of the Bosmer
			7 = { culture:pellitinian = { save_scope_as = slave_culture }} #Khajiit unfortunately are commonly enslaved, Pellininians are coastal and easiest to catch
			7 = { culture:chi_addun = { save_scope_as = slave_culture }} # We also know some Dunmer are enslaved by Altmer, and the Chi Adduni seem the likely sort to sell of their own in Port Telvannis
			7 = { culture:abecean = { save_scope_as = slave_culture }} # Coastal Redguards are at higher risk of trafficking by Abecean pirates
			7 = { culture:strident = { save_scope_as = slave_culture }} # Same as above, Stridents are victimised by Abeceans and sold off
		}
	}	

	### Morrowind ###
	else_if = {
		limit = {
			$LOCATION$ = {
				geographical_region = mundus_tamriel_morrowind
			}
		}
		random_list = {
			20 = { culture:hleel = { save_scope_as = slave_culture }} # Argonians are the most common slaves in Morrowind and the Hleel are closest
			15 = { culture:hapsleet = { save_scope_as = slave_culture }} # Hapsleet are coastal and easy to catch, no need to enter the inner marsh
			15 = { culture:pellitinian = { save_scope_as = slave_culture }} # Khajiit are the second biggest slave population in Morrowind, Pellitinians are numerous and coastal
			10 = { culture:baandari = { save_scope_as = slave_culture }} # Baandari are found pretty much everywhere, don't even need to go to Elsweyr to capture them
			5 = { culture:mountain_orc = { save_scope_as = slave_culture }} # Orcs aren't very well regarded
			5 = { culture:goblin = { save_scope_as = slave_culture }} # Neither are Goblins
			5 = { culture:eastmarcher = { save_scope_as = slave_culture }} # Dunmer have a long history with the Nords, and Eastmarchers are the closest
			1 = { culture:chuzei = { save_scope_as = slave_culture }} # Dunmer don't discriminate, they also enslave their own kind. Each Dunmeri culture in Morrowind is equally represented
			1 = { culture:chi_addun = { save_scope_as = slave_culture }}
			1 = { culture:marduhn_oad = { save_scope_as = slave_culture }}
			1 = { culture:armun_an = { save_scope_as = slave_culture }}
			1 = { culture:gah_julan = { save_scope_as = slave_culture }}
			1 = { culture:ashlander = { save_scope_as = slave_culture }}
		}
	}

	### Valenwood ###
	else_if = {
		limit = {
			$LOCATION$ = {
				geographical_region = mundus_tamriel_valenwood
			}
		}
		random_list = {
			20 = { culture:bosmer = { save_scope_as = slave_culture }} # Bosmer are the majority population and quite populous
			15 = { culture:grahtwood = { save_scope_as = slave_culture }} # Etarani border the Mathmeldi, which is the main slaver culture in Valenwood
			15 = { culture:arenthi = { save_scope_as = slave_culture }} # Arenthia / Reaper's March / South Weald is a crossroads of conflict, plenty of prisoners to catch of all three cultures
			15 = { culture:anequinan = { save_scope_as = slave_culture }} 
			10 = { culture:colovian = { save_scope_as = slave_culture }} 
			10 = { culture:wood_orc = { save_scope_as = slave_culture }} # Orcs aren't very well regarded 
			10 = { culture:baandari = { save_scope_as = slave_culture }} # Baandari are found pretty much everywhere, don't even need to go to Elsweyr to capture them
			5 = { culture:imga = { save_scope_as = slave_culture }} # The Ape Men are relatively rare but highly valued slaves
		}
	}

	### Cyrodiil ###
	else_if = {
		limit = {
			$LOCATION$ = {
				geographical_region = mundus_tamriel_cyrodiil
			}
		}
		random_list = {
			20 = { culture:colovian = { save_scope_as = slave_culture }} # The two biggest Cyrodiilic groups are more likely slaves in Cyrodiil
			20 = { culture:nibenese = { save_scope_as = slave_culture }}
			10 = { culture:heartlander = { save_scope_as = slave_culture }} # The four smaller human ones are still highly likely 
			10 = { culture:strident = { save_scope_as = slave_culture }}
			10 = { culture:nibenu = { save_scope_as = slave_culture }}
			10 = { culture:cyro_nord = { save_scope_as = slave_culture }}
			5 = { culture:anequinan = { save_scope_as = slave_culture }} # In Cyrodiil too, Khajiit are easy targets and often dehumanised
			5 = { culture:naga = { save_scope_as = slave_culture }} # Same with Argonians
			5 = { culture:arenthi = { save_scope_as = slave_culture }} # Going by the assumption that most slavers setting up camp in Cyrodiil are Ayleids, they'll reasonably do raids into Valenwood and Black Marsh too
			5 = { culture:kothringi = { save_scope_as = slave_culture }}
		}
	}

	### Skyrim ###
	else_if = {
		limit = {
			$LOCATION$ = {
				geographical_region = mundus_tamriel_skyrim
			}
		}
		random_list = {
			25 = { culture:eastmarcher = { save_scope_as = slave_culture }} # Eastmarcher and Westholders are the biggest Nord groups in Skyrim
			25 = { culture:westmarcher = { save_scope_as = slave_culture }}
			15 = { culture:reachfolk = { save_scope_as = slave_culture }} # Reachfolk are relatively numerous and disorganised enough that they're easy enough to capture
			10 = { culture:mountain_orc = { save_scope_as = slave_culture }} # Orcs aren't very well regarded 
			5 = { culture:riekling = { save_scope_as = slave_culture }} # The people of Solstheim are also subjected to raids to their island
			5 = { culture:skaal = { save_scope_as = slave_culture }}
		}
	}
	### Black Marsh ###
	else_if = {
		limit = {
			$LOCATION$ = {
				geographical_region = mundus_tamriel_black_marsh
			}
		}
		random_list = {
			20 = { culture:hleel = { save_scope_as = slave_culture }} # These Argonians live in the outer areas of Black Marsh, and are therefore easier to get ahold of
			15 = { culture:hapsleet = { save_scope_as = slave_culture }}
			15 = { culture:agaceph = { save_scope_as = slave_culture }}
			5 = { culture:naga = { save_scope_as = slave_culture }} # While these Argonians make their homes in the inner marsh
			5 = { culture:sarpa = { save_scope_as = slave_culture }}
			5 = { culture:paatru = { save_scope_as = slave_culture }}
			10 = { culture:yespest = { save_scope_as = slave_culture }} # The Nedes of Black Marsh all live in the outer parts, but are not very numerous
			10 = { culture:kothringi = { save_scope_as = slave_culture }}
			5 = { culture:orma = { save_scope_as = slave_culture }} # Orma and Horwalli are further away from the slaver Ayleids of the province
			5 = { culture:horwalli = { save_scope_as = slave_culture }}
			5 = { culture:lilmothiit = { save_scope_as = slave_culture }} # The Lilmothiit have few allies and many enemies in Black Marsh
		}
	}
	### This fallback is used when no specific region is checked
	else = {
		$LOCATION$.culture = {
			save_scope_as = slave_culture
		}
	}
	# then we assign an appropriate faith
	# since faith and culture is so intertwined in TES, let's ensure the slave follows their own people's faith
	# each culture just gets one faith assigned, the most widespread one for their culture, no reason to make this even more complicated

	# Argonians
	if = {
		limit = {
			scope:slave_culture = culture:hleel
		}
		faith:hist = {
			save_scope_as = slave_faith
		}
	}
	else_if = {
		limit = {
			scope:slave_culture = culture:hapsleet
		}
		faith:hist = {
			save_scope_as = slave_faith
		}
	}
	else_if = {
		limit = {
			scope:slave_culture = culture:naga
		}
		faith:hist = {
			save_scope_as = slave_faith
		}
	}
	else_if = {
		limit = {
			scope:slave_culture = culture:sarpa
		}
		faith:hist = {
			save_scope_as = slave_faith
		}
	}
	else_if = {
		limit = {
			scope:slave_culture = culture:paatru
		}
		faith:hist = {
			save_scope_as = slave_faith
		}
	}
	else_if = {
		limit = {
			scope:slave_culture = culture:agaceph
		}
		faith:hist = {
			save_scope_as = slave_faith
		}
	}
	# Atmorans
	else_if = {
		limit = {
			scope:slave_culture = culture:eastmarcher
		}
		faith:nord_cult = {
			save_scope_as = slave_faith
		}
	}
	else_if = {
		limit = {
			scope:slave_culture = culture:westmarcher
		}
		faith:nord_cult = {
			save_scope_as = slave_faith
		}
	}
	else_if = {
		limit = {
			scope:slave_culture = culture:cyro_nord
		}
		faith:nord_cult = {
			save_scope_as = slave_faith
		}
	}
	# Bosmer
	else_if = {
		limit = {
			scope:slave_culture = culture:bosmer
		}
		faith:greenpact = {
			save_scope_as = slave_faith
		}
	}
	else_if = {
		limit = {
			scope:slave_culture = culture:grahtwood
		}
		faith:greenpact = {
			save_scope_as = slave_faith
		}
	}
	else_if = {
		limit = {
			scope:slave_culture = culture:arenthi
		}
		faith:vineduskpact = {
			save_scope_as = slave_faith
		}
	}
	# Cyrodiilics
	else_if = {
		limit = {
			scope:slave_culture = culture:strident
		}
		faith:imperial_cult = {
			save_scope_as = slave_faith
		}
	}
	else_if = {
		limit = {
			scope:slave_culture = culture:colovian
		}
		faith:imperial_cult = {
			save_scope_as = slave_faith
		}
	}
	else_if = {
		limit = {
			scope:slave_culture = culture:nibenese
		}
		faith:imperial_cult = {
			save_scope_as = slave_faith
		}
	}
	else_if = {
		limit = {
			scope:slave_culture = culture:heartlander
		}
		faith:imperial_cult = {
			save_scope_as = slave_faith
		}
	}
	else_if = {
		limit = {
			scope:slave_culture = culture:nibenu
		}
		faith:niben_cult = {
			save_scope_as = slave_faith
		}
	}
	# Dunmer
	else_if = {
		limit = {
			scope:slave_culture = culture:chi_addun
		}
		faith:tribunal_temple = {
			save_scope_as = slave_faith
		}
	}
	else_if = {
		limit = {
			scope:slave_culture = culture:gah_julan
		}
		faith:tribunal_temple = {
			save_scope_as = slave_faith
		}
	}
	else_if = {
		limit = {
			scope:slave_culture = culture:chuzei
		}
		faith:tribunal_temple = {
			save_scope_as = slave_faith
		}
	}
	else_if = {
		limit = {
			scope:slave_culture = culture:armun_an
		}
		faith:tribunal_cult = {
			save_scope_as = slave_faith
		}
	}
	else_if = {
		limit = {
			scope:slave_culture = culture:marduhn_oad
		}
		faith:tribunal_temple = {
			save_scope_as = slave_faith
		}
	}
	else_if = {
		limit = {
			scope:slave_culture = culture:ashlander
		}
		faith:old_velothi = {
			save_scope_as = slave_faith
		}
	}
	# Goblinken
	else_if = {
		limit = {
			scope:slave_culture = culture:goblin
		}
		faith:goblin_shamanism = {
			save_scope_as = slave_faith
		}
	}
	else_if = {
		limit = {
			scope:slave_culture = culture:riekling
		}
		faith:goblin_shamanism = {
			save_scope_as = slave_faith
		}
	}
	# Imga
	else_if = {
		limit = {
			scope:slave_culture = culture:imga
		}
		faith:ius_cult = {
			save_scope_as = slave_faith
		}
	}
	# Khajiit
	else_if = {
		limit = {
			scope:slave_culture = culture:pellitinian
		}
		faith:twomoonsdance = {
			save_scope_as = slave_faith
		}
	}
	else_if = {
		limit = {
			scope:slave_culture = culture:anequinan
		}
		faith:manypathsdance = {
			save_scope_as = slave_faith
		}
	}
	else_if = {
		limit = {
			scope:slave_culture = culture:baandari
		}
		faith:baandari_code = {
			save_scope_as = slave_faith
		}
	}
	# Lilmothiit
	else_if = {
		limit = {
			scope:slave_culture = culture:lilmothiit
		}
		faith:lilmothiit_hist = {
			save_scope_as = slave_faith
		}
	}
	# Nedes
	else_if = {
		limit = {
			scope:slave_culture = culture:kothringi
		}
		faith:nedic_cult = {
			save_scope_as = slave_faith
		}
	}
	else_if = {
		limit = {
			scope:slave_culture = culture:horwalli
		}
		faith:nedic_cult = {
			save_scope_as = slave_faith
		}
	}
	else_if = {
		limit = {
			scope:slave_culture = culture:yespest
		}
		faith:sanguine_mysteries = {
			save_scope_as = slave_faith
		}
	}
	else_if = {
		limit = {
			scope:slave_culture = culture:orma
		}
		faith:orma_cult = {
			save_scope_as = slave_faith
		}
	}
	else_if = {
		limit = {
			scope:slave_culture = culture:reachfolk
		}
		faith:old_gods = {
			save_scope_as = slave_faith
		}
	}
	# Orcs
	else_if = {
		limit = {
			scope:slave_culture = culture:mountain_orc
		}
		faith:code_of_malacath = {
			save_scope_as = slave_faith
		}
	}
	else_if = {
		limit = {
			scope:slave_culture = culture:wood_orc
		}
		faith:code_of_malacath = {
			save_scope_as = slave_faith
		}
	}
	# Yokudans
	else_if = {
		limit = {
			scope:slave_culture = culture:abecean
		}
		faith:redguard_cult = {
			save_scope_as = slave_faith
		}
	}
	### This fallback is used when no specific region is checked
	else = {
		$LOCATION$.faith = {
			save_scope_as = slave_faith
		}
	}
}	

#note: if a similar variable is to be assigned to a formed title, assign the flags as house_value_x_1 to prevent overlap with voting pattern of established houses
#GCM TODO: unless GH status is dynamic, the variables are redundant
#preset_great_house_voting_pattern = { #to setup the game start Great House Succession voting pattern
#	scope:title = {
#		title:k_redoran = {
#			set_variable = flag:house_value_martial
#			set_variable = flag:house_value_learning
#		}	
#	}
#	scope:title = {
#		title:k_hlaalu = {
#			set_variable = flag:house_value_diplomacy
#			set_variable = flag:house_value_stewardship
#		}	
#	}
#	scope:title = {
#		title:k_indoril = {
#			set_variable = flag:house_value_martial
#			set_variable = flag:house_value_learning
#		}	
#	}
#	scope:title = {
#		title:k_dres = {
#			set_variable = flag:house_value_martial
#			set_variable = flag:house_value_stewardship
#		}	
#	}
#	scope:title = {
#		title:k_telvanni = {
#			set_variable = flag:house_value_intrigue
#			set_variable = flag:house_value_arcana
#		}	
#	}
#}

create_vivec_effect = {
	random_list = {
		60 =  {
			create_character = {
				location = root.capital_province
				template = vivec_male
				#dna = vivec_male_dna_entry # this doesnt work, so we copy inheritable appearance from a dead, unlanded, related-to-no-one character instead
				name = "Vivec"					
				dynasty = none
				save_scope_as = vivec
				after_creation = {
					copy_inheritable_appearance_from = character:vehk_101_male
					add_arcana_skill = { VALUE = 30 }
					ek_character_setup_effect = yes
					ek_magic_perks_effect = yes
					set_immortal_age = 25
					add_character_flag = god_vivec_m_flag
					add_character_flag = has_scripted_appearance
					add_character_flag = god_character
				}
			}
		}
		40 = {
			modifier = {
				factor = 0
				should_show_nudity = no # cant be bothered to make a version with a bra atm, so for now she can only show up if nudity is enabled
			}
			create_character = {
				location = root.capital_province
				template = vivec_female
				#dna = vivec_female_dna_entry # this doesnt work, so we copy inheritable appearance from a dead, unlanded, related-to-no-one character instead
				name = "Vivec"
				dynasty = none
				save_scope_as = vivec
				after_creation = {
					copy_inheritable_appearance_from = character:vehk_101_female
					add_arcana_skill = { VALUE = 30 }
					ek_character_setup_effect = yes
					ek_magic_perks_effect = yes
					set_immortal_age = 25
					add_character_flag = god_vivec_f_flag
					add_character_flag = has_scripted_appearance
					add_character_flag = god_character
				}			
			}
		}
	}
}

apply_dies_irae_effect = {
	custom_tooltip = vivec_dies_irae
	hidden_effect = {
		random_list = {
			100 = {
				root = {
					send_interface_toast = {
						title = vivec_teleported
						scope:army = {
							set_army_location = scope:teleport_location
						}
					}
				}
			}
			100 = {
				trigger = {
					scope:army_commander = {
						NOT = {
							has_trait = lunatic
						}
					}
				}
				root = {
					send_interface_toast = {
						title = vivec_lunatic
						scope:army_commander = {
							add_trait = lunatic_1
						}
					}
				}
			}
			100 = {
				trigger = {
					scope:army_commander = {
						has_magic_perk_trigger = yes
						NOT = {
							has_trait = disrupted
						}
					}
				}
				root = {
					send_interface_toast = {
						title = vivec_disrupted
						scope:army_commander = {
							add_trait = disrupted
						}
					}
				}
			}
			100 = {
				trigger = {
					scope:army_commander = {
						NOT = {
							has_trait = one_eyed
						}
					}
				}
				root = {
					send_interface_toast = {
						title = vivec_one_eyed
						scope:army_commander = {
							add_trait = one_eyed
						}
					}
				}
			}
			100 = {
				root = {
					send_interface_toast = {
						title = vivec_death
						scope:army_commander = {
							death = {
								death_reason = death_vivec
							}
						}
					}
				}
			}
		}
	}
}
remove_birthsign = {
	if = {
		limit = {
			has_trait = birthsign
		}
		every_character_trait = {
			limit = {
				has_trait_flag = birthsign
			}
			prev = {
				remove_trait = prev
			}
		}
	}
}

restore_mane_scripted_effect = {
	save_scope_as = reformer
	#Create Mane character
	hidden_effect = {
		create_character = {
			employer = root
			template = mane_leader_character
			random_traits = no
			save_scope_as = new_mane
		}
	}
	scope:new_mane.faith = {
		change_fervor = {
			value = 15
			desc = fervor_gain_recreated_hof
		}
		if = {
			limit = { has_doctrine = doctrine_no_head }
			hidden_effect = { remove_doctrine = doctrine_no_head }
			add_doctrine = doctrine_mystical_birthright_head
		}
	}
	if = {
		limit = { scope:new_mane.faith = faith:twomoonsdance }
		scope:new_mane = { set_house = character:mane_001.house } #Setting Two Moons Dynasty
	}
	else_if = {
		limit = { scope:new_mane.faith = faith:manypathsdance }
		scope:new_mane = { set_house = character:mane_mp_003.house } #Setting Many Paths Dynasty
	}
	else_if = {
		limit = { scope:new_mane.faith = faith:order_new_moon }
		scope:new_mane = { set_house = character:new_moon_ancient_001.house } #Setting New Moon Dynasty
	}
	create_title_and_vassal_change = {
		type = returned
		save_scope_as = change
		add_claim_on_loss = no
	}
	if = {
		limit = {
			scope:new_mane.faith = faith:twomoonsdance
		}
		title:d_mane = {
			change_title_holder = {
				holder = scope:new_mane
				change = scope:change
			}
		}
	}
	else_if = {
		limit = {
			scope:new_mane.faith = faith:manypathsdance
		}
		title:d_many_paths_mane = {
			change_title_holder = {
				holder = scope:new_mane
				change = scope:change
			}
		}
	}
	else_if = {
		limit = {
			scope:new_mane.faith = faith:order_new_moon
		}
		title:d_new_moon_mane = {
			change_title_holder = {
				holder = scope:new_mane
				change = scope:change
			}
		}
	}
	title:c_torval = {
		change_title_holder = {
			holder = scope:new_mane
			change = scope:change
		}
	}
	title:d_torval = {
		change_title_holder = {
			holder = scope:new_mane
			change = scope:change
		}
	}
	resolve_title_and_vassal_change = scope:change
	scope:new_mane = {
		set_realm_capital = title:c_torval
		change_government = hierocracy_government		
	}
}

#Based on vanilla destroy papacy effect
destroy_mane_scripted_effect = {
	save_scope_as = mane_destroyer
	if = {
		limit = { exists = title:d_mane.holder }
		title:d_mane.holder = { save_scope_as = destroyed_mane }
	}
	add_piety = massive_piety_gain
	root.faith = {
		change_fervor = {
			value = 50
			desc = fervor_gain_religious_war #EK TODO: unique desc, look at og effect in vanilla
		}
	}

	# Destroy the papacy title if it exists.
	if = {
		limit = {
			exists = title:d_mane
		}
		destroy_title = title:d_mane
	}

	# Catholicism is now sad.
	faith:twomoonsdance = {
		change_fervor = {
			value = -100
			desc = fervor_loss_great_holy_war
		}
		if = {
			limit = { has_doctrine = doctrine_mystical_birthright_head }
			remove_doctrine = doctrine_mystical_birthright_head
			hidden_effect = { add_doctrine = doctrine_no_head }
		}
	}
}

#simple effect to fill your court with same culture same faith courtiers when reviving a dead culture
ek_fill_court_effect = {
	random_list = {
		10 = {
			# a potential spouse candidate
			create_character = {
				location = root.capital_province
				culture = root.culture
				faith = root.faith
				template = pool_repopulate_spouse

				save_scope_as = created_courtier

				after_creation = {
					ek_character_setup_effect = yes
				}
			}
		}
		10 = {
			# a decent knight
			create_character = {
				location = root.capital_province
				culture = root.culture
				faith = root.faith
				template = pool_repopulate_prowess
				prowess = { invite_knights_decision_standard_value invite_knights_decision_upper_value }

				save_scope_as = created_courtier

				after_creation = {
					ek_character_setup_effect = yes
				}
			}
		}
		10 = {
			# some assorted courtiers to serve as councillors
			create_character = {
				location = root.capital_province
				culture = root.culture
				faith = root.faith
				template = pool_repopulate_diplomacy

				save_scope_as = created_courtier

				after_creation = {
					ek_character_setup_effect = yes
				}
			}
		}
		10 = {
			create_character = {
				location = root.capital_province
				culture = root.culture
				faith = root.faith
				template = pool_repopulate_martial

				save_scope_as = created_courtier

				after_creation = {
					ek_character_setup_effect = yes
				}
			}
		}
		10 = {
			create_character = {
				location = root.capital_province
				culture = root.culture
				faith = root.faith
				template = pool_repopulate_stewardship

				save_scope_as = created_courtier

				after_creation = {
					ek_character_setup_effect = yes
				}
			}
		}
		10 = {
			create_character = {
				location = root.capital_province
				culture = root.culture
				faith = root.faith
				template = pool_repopulate_intrigue

				save_scope_as = created_courtier

				after_creation = {
					ek_character_setup_effect = yes
				}
			}
		}
		10 = {
			create_character = {
				location = root.capital_province
				culture = root.culture
				faith = root.faith
				template = pool_repopulate_learning

				save_scope_as = created_courtier

				after_creation = {
					ek_character_setup_effect = yes
				}
			}
		}
		10 = {
			# a mage
			create_character = {
				location = root.capital_province
				culture = root.culture
				faith = root.faith
				template = pool_repopulate_arcana

				save_scope_as = created_courtier

				after_creation = {
					ek_character_setup_effect = yes
				}
			}
		}
		10 = {
			# random bozo
			create_character = {
				location = root.capital_province
				culture = root.culture
				faith = root.faith
				template = pool_repopulate_local_flavor

				save_scope_as = created_courtier

				after_creation = {
					ek_character_setup_effect = yes
				}
			}
		}
	}

	root = {
		add_courtier = scope:created_courtier
	}
}

#######################
### CLONING EFFECTS ###
#######################
# Create the Clone
cl_create_clone_effect = {
	# Save our Scopes
	$CREATOR$ = {
		save_scope_as = creator
		save_scope_as = recipient # Used in some scripted effects
		save_scope_as = actor # Used in some scripted effects
	}
	scope:creator = {
		if = {
			limit = {
				any_owned_story = { story_type = story_cycle_cloning }
			}
			random_owned_story = {
				limit = { story_type = story_cycle_cloning }
				save_scope_as = story
			}
		}
	}

	### Check Clone Age
	# During the cloning process, we may age the clone artificially (life_extension.0156)
	if = {
		limit = {
			scope:story ?= { has_variable = cl_age }
		}
		set_variable = {
			name = cl_age
			value = scope:story.var:cl_age
		}
	}
	else = {
		set_variable = {
			name = cl_age
			value = 0
		}
	}

	### Make the Clone
	if = { # One female Clone Please
		limit = {
			exists = this
			exists = scope:creator
			OR = {
				AND = { # We are female and didnt trans our clone
					scope:creator = { is_female = yes }
					NOT = { scope:story ?= { has_variable = cl_switch_gender } }
				}
				AND = { #We are male and transed our clone (life_extension.0154)
					scope:creator = { is_male = yes }
					scope:story ?= { has_variable = cl_switch_gender }
				}
			}
		}
		create_character = {
			name		= Project
			location	= scope:creator.capital_province
			template	= clone_template
			gender		= female
			culture		= scope:creator.culture
			faith		= scope:creator.faith
			age			= var:cl_age
			diplomacy	= 0
			martial		= 0
			stewardship	= 0
			intrigue	= 0
			learning	= 0
			prowess		= 0
			save_scope_as	= clone
		}
	}
	else_if = { # One male Clone Please
		limit = {
			exists = this
			exists = scope:creator
			OR = {
				AND = { # We are male and didnt trans our clone
					scope:creator = { is_male = yes }
					NOT = { scope:story ?= { has_variable = cl_switch_gender } }
				}
				AND = { #We are female and transed our clone (life_extension.0154)
					scope:creator = { is_female = yes }
					scope:story ?= { has_variable = cl_switch_gender }
				}
			}
		}
		create_character = {
			name		= Project
			location	= scope:creator.capital_province
			template	= clone_template
			gender		= male
			culture		= scope:creator.culture
			faith		= scope:creator.faith
			age			= var:cl_age
			diplomacy	= 0
			martial		= 0
			stewardship	= 0
			intrigue	= 0
			learning	= 0
			prowess		= 0
			save_scope_as	= clone
		}
	}

	scope:clone ?= {
		### Clone Skills
		# During the cloning process, we may impact the clone's starting skill points (life_extension.0152)

		cl_save_stats_var_effect = { STAT = diplomacy	}
		cl_save_stats_var_effect = { STAT = martial		}
		cl_save_stats_var_effect = { STAT = stewardship	}
		cl_save_stats_var_effect = { STAT = intrigue	}
		cl_save_stats_var_effect = { STAT = learning	}
		cl_save_stats_var_effect = { STAT = prowess		}
		cl_save_stats_var_effect = { STAT = arcana		}

		add_diplomacy_skill		= var:cl_diplomacy
		add_martial_skill		= var:cl_martial	
		add_stewardship_skill	= var:cl_stewardship
		add_intrigue_skill		= var:cl_intrigue
		add_learning_skill		= var:cl_learning
		add_prowess_skill		= var:cl_prowess
		add_arcana_skill 		= { VALUE = var:cl_arcana }

		# Appearance and Court
		copy_inheritable_appearance_from = scope:creator
		set_employer = scope:creator

		# Hatchling
		if = {
			limit = {
				culture = {
					has_cultural_pillar = heritage_argonian
					NOT = {
						this = culture:ojel
						any_parent_culture_or_above = {
							this = culture:ojel
						}
					}
				}
			}
			change_first_name = Hatchling
		}
	}

	### Clone traits
	scope:clone ?= {
		# Clear randomly assigned traits and unfitting traits given via ek_character_setup_effect
		every_character_trait = {
			limit = {
				OR = {
					has_trait_flag = furstock
					this = trait:lifespan_1
					this = trait:lifespan_2
					this = trait:lifespan_3
					this = trait:lifespan_4

					this = trait:arcana_bad_1
					this = trait:arcana_bad_2
					this = trait:arcana_bad_3
					this = trait:arcana_good_1
					this = trait:arcana_good_2
					this = trait:arcana_good_3
					this = trait:beauty_bad_1
					this = trait:beauty_bad_2
					this = trait:beauty_bad_3
					this = trait:beauty_good_1
					this = trait:beauty_good_2
					this = trait:beauty_good_3
					this = trait:intellect_bad_1
					this = trait:intellect_bad_2
					this = trait:intellect_bad_3
					this = trait:intellect_good_1
					this = trait:intellect_good_2
					this = trait:intellect_good_3
					this = trait:physique_bad_1
					this = trait:physique_bad_2
					this = trait:physique_bad_3
					this = trait:physique_good_1
					this = trait:physique_good_2
					this = trait:physique_good_3
					this = trait:fecund
					this = trait:clubfooted
					this = trait:hunchbacked
					this = trait:lisping
					this = trait:stuttering
					this = trait:giant
					this = trait:inbred
					this = trait:spindly
					this = trait:scaly
					this = trait:albino
					this = trait:wheezing
					this = trait:bleeder
					this = trait:infertile
					this = trait:depressed_genetic
					this = trait:lunatic_genetic
					this = trait:possessed_genetic
					this = trait:pure_blooded
					this = trait:impure

					this = trait:sayyid
					this = trait:saoshyant_descendant
					this = trait:divine_blood
					this = trait:blood_of_prophet
				}
			}
			scope:clone = { remove_trait = prev }
		}
		remove_birthsign = yes

		#Birthsign traits
		if = {
			limit = { NOT = { has_trait = birthsign } }
			assign_birthsign_start_effect = yes
		}
		
		#Clone Trait
		set_variable = {
			name = clone_creator
			value = scope:creator
		}
		add_trait = clone
	}
	#Copy Creator traits
	scope:creator ?= {
		every_character_trait = {
			limit = {
				OR = {
					has_trait_flag = furstock

					this = trait:arcana_bad_1
					this = trait:arcana_bad_2
					this = trait:arcana_bad_3
					this = trait:arcana_good_1
					this = trait:arcana_good_2
					this = trait:arcana_good_3
					this = trait:beauty_bad_1
					this = trait:beauty_bad_2
					this = trait:beauty_bad_3
					this = trait:beauty_good_1
					this = trait:beauty_good_2
					this = trait:beauty_good_3
					this = trait:intellect_bad_1
					this = trait:intellect_bad_2
					this = trait:intellect_bad_3
					this = trait:intellect_good_1
					this = trait:intellect_good_2
					this = trait:intellect_good_3
					this = trait:physique_bad_1
					this = trait:physique_bad_2
					this = trait:physique_bad_3
					this = trait:physique_good_1
					this = trait:physique_good_2
					this = trait:physique_good_3
					this = trait:fecund
					this = trait:clubfooted
					this = trait:hunchbacked
					this = trait:lisping
					this = trait:stuttering
					this = trait:giant
					this = trait:inbred
					this = trait:spindly
					this = trait:scaly
					this = trait:albino
					this = trait:wheezing
					this = trait:bleeder
					this = trait:infertile
					this = trait:depressed_genetic
					this = trait:lunatic_genetic
					this = trait:possessed_genetic
					this = trait:pure_blooded
					this = trait:impure

					this = trait:sayyid
					this = trait:saoshyant_descendant
					this = trait:divine_blood
					this = trait:blood_of_prophet
				}
			}
			scope:clone ?= { add_trait = prev }
		}
	}

	### Copy Special Blood Traits
	# Then check for it and transfer
	if = { # For completions sake
		limit = {
			scope:creator = { has_trait = saoshyant }
		}
		scope:clone = { add_trait = saoshyant_descendant }
	}
	if = {
		limit = {
			scope:creator = { has_trait = savior }
		}
		scope:clone = { add_trait = divine_blood }
	}
	if = {
		limit = {
			scope:creator = { has_trait = paragon }
		}
		scope:clone = { add_trait = consecrated_blood }
	}

	### Copy Natural Lifespan
	# Save natural lifespan for inheritance purposes
	scope:creator = { save_lifespan_effect = yes }
	# Then check for it and transfer
	if = {
		limit = {
			scope:creator = { has_character_flag = natural_lifespan_1 }
		}
		scope:clone = { add_trait = lifespan_1 }
	}
	else_if = {
		limit = {
			scope:creator = { has_character_flag = natural_lifespan_2 }
		}
		scope:clone = { add_trait = lifespan_2 }
	}
	else_if = {
		limit = {
			scope:creator = { has_character_flag = natural_lifespan_3 }
		}
		scope:clone = { add_trait = lifespan_3 }
	}
	else_if = {
		limit = {
			scope:creator = { has_character_flag = natural_lifespan_4 }
		}
		scope:clone = { add_trait = lifespan_4 }
	}

	### Congenital Improvement
	# During the cloning process, we may improve the Clone's congenital traits (life_extension.0153)
	scope:clone ?= {
		cl_improve_clone_congenital_effect = { TRAIT = physique }
		cl_improve_clone_congenital_effect = { TRAIT = beauty }
		cl_improve_clone_congenital_effect = { TRAIT = intellect }
		cl_improve_clone_congenital_effect = { TRAIT = arcana }
		# Second Upgrade Check
		if = {
			limit = { scope:story ?= { has_variable = cl_congenital_physique_2 } }
			cl_improve_clone_congenital_effect = { TRAIT = physique }
		}
		if = {
			limit = { scope:story ?= { has_variable = cl_congenital_beauty_2 } }
			cl_improve_clone_congenital_effect = { TRAIT = beauty }
		}
		if = {
			limit = { scope:story ?= { has_variable = cl_congenital_intellect_2 } }
			cl_improve_clone_congenital_effect = { TRAIT = intellect }
		}
		if = {
			limit = { scope:story ?= { has_variable = cl_congenital_arcana_2 } }
			cl_improve_clone_congenital_effect = { TRAIT = arcana }
		}
	}

	### Infertility Penalty
	# During the cloning process, if you fail certain events, your clone may be infertile (life_extension.0154)
	scope:clone ?= {
		if = {
			limit = {
				scope:story ?= { has_variable = cl_infertile_chance }
				NOR = {
					has_trait = infertile
					has_trait = impotent
				}
			}
			remove_trait = fecund
			random_list = {
				10 = { }
				10 = { add_trait = infertile }
				10 = { add_trait = infertile }
			}
		}
	}

	### Size Improvement
	# During the cloning process, we may change the clones size (life_extension.0155)
	scope:clone ?= {
		if = {
			limit = { scope:story ?= { has_variable = cl_size_standard } }
			remove_trait = giant
			remove_trait = dwarf
		}
		else_if = {
			limit = { scope:story ?= { has_variable = cl_size_giant } }
			remove_trait = dwarf
			add_trait = giant
		}
		else_if = {
			limit = { scope:story ?= { has_variable = cl_size_dwarf } }
			remove_trait = giant
			add_trait = dwarf
		}
	}

	### Lycanthropy
	# During the cloning process, we may turn out clone into a werewolf (life_extension.0158)
	scope:clone ?= {
		if = {
			limit = {
				scope:story ?= { has_variable = cl_werewolf }
			}
			give_lycan_secret_or_trait_effect = yes
		}
	}

	### Unforeseen Consequences
	# During the cloning process, if you fail certain events, your clone may receive random negative traits
	# Roll lottery X times depending on severity of meddling
	scope:clone ?= {
		if = {
			limit = {
				exists = scope:story.var:cl_negative_traits
				scope:story.var:cl_negative_traits > 0
			}
			while = {
				limit = { scope:story.var:cl_negative_traits > 0 }
				cl_negative_traits_lottery_effect = yes
				scope:story = {
					change_variable = {
						name = cl_negative_traits
						add = -1
					}
				}
			}
		}

		### Cleanup
		remove_variable = cl_age
		remove_variable = diplomacy
		remove_variable = cl_martial
		remove_variable = cl_stewardship
		remove_variable = cl_intrigue
		remove_variable = cl_learning
		remove_variable = cl_prowess
	}

	### Cleanup
	remove_variable = cl_age
	remove_variable = diplomacy
	remove_variable = cl_martial
	remove_variable = cl_stewardship
	remove_variable = cl_intrigue
	remove_variable = cl_learning
	remove_variable = cl_prowess
}

# Gain a Cloning Insight
cl_gain_cloning_insight_effect = {
	custom_tooltip = {
		text = cl_get_cloning_insight_tt
		if = {
			limit = { NOT = { has_variable = cl_cloning_insights } }
			set_variable = {
				name = cl_cloning_insights
				value = 1
			}
		}
		else = {
			change_variable = {
				name = cl_cloning_insights
				add = 1
			}
		}
	}
}

# Reduce Cloning Project Success Chance
cl_change_success_chance_effect = {
	# Reduce Cloning Project Success Chance
	if = {
		limit = {
			$VALUE$ < -1
		}
		custom_tooltip = { # Strongly Reduce Success Chance Loc
			text = cl_much_worse_cloning_outcome_tt
			if = {
				limit = { exists = scope:story.var:cl_success_chance }
				scope:story = {
					change_variable = { # Cloning Success Chance Modifier
						name = cl_success_chance
						add = $VALUE$
					}
				}
			}
		}
	}
	else_if = {
		limit = {
			$VALUE$ < 0
		}
		custom_tooltip = { # Reduce Success Chance Loc
			text = cl_worse_cloning_outcome_tt
			if = {
				limit = { exists = scope:story.var:cl_success_chance }
				scope:story = {
					change_variable = { # Cloning Success Chance Modifier
						name = cl_success_chance
						add = $VALUE$
					}
				}
			}
		}
	}
	else_if = {
		limit = {
			$VALUE$ > 1
		}
		custom_tooltip = { # Strongly Increase Success Chance Loc
			text = cl_much_better_cloning_outcome_tt
			if = {
				limit = { exists = scope:story.var:cl_success_chance }
				scope:story = {
					change_variable = { # Cloning Success Chance Modifier
						name = cl_success_chance
						add = $VALUE$
					}
				}
			}
		}
	}
	# Improve Cloning Project Success Chance
	else = {
		custom_tooltip = { # Improve Success Chance Loc
			text = cl_better_cloning_outcome_tt
			if = {
				limit = { exists = scope:story.var:cl_success_chance }
				scope:story = {
					change_variable = { # Cloning Success Chance Modifier
						name = cl_success_chance
						add = $VALUE$
					}
				}
			}
		}
	}
}

# Negative Clone Traits
cl_negative_traits_lottery_effect = {
	# Lottery to get negative trait
	# Can run several times
	# If selected trait or opposite is already on char, do nothing
	random_list = {
		50 = {}
		30 = { add_trait = weak }
		30 = { add_trait = dull }
		5 = { add_trait = clubfooted }
		5 = { add_trait = hunchbacked }
		5 = { add_trait = one_eyed }
		5 = { add_trait = one_legged }
		5 = { add_trait = blind }
		5 = { add_trait = lunatic_genetic }
		5 = { add_trait = possessed_genetic }
		5 = { add_trait = depressed_genetic }
		5 = { add_trait = lisping }
		5 = { add_trait = stuttering }
		5 = { add_trait = infertile }
		5 = { add_trait = impotent }
		5 = { add_trait = spindly }
		5 = { add_trait = scaly }
		5 = { add_trait = albino }
		5 = { add_trait = wheezing }
		5 = { add_trait = bleeder }
	}
}

# Make the clone weak
cl_weak_clone_effect = {
	add_trait = sickly
	remove_trait = strong
	contract_disease_effect = { DISEASE = cancer TREATMENT_EVENT = no }
	add_trait = wounded_3
	remove_trait = physique_good_3
	remove_trait = physique_good_2
	remove_trait = physique_good_1
	remove_trait = beauty_good_3
	remove_trait = beauty_good_2
	remove_trait = beauty_good_1
	random_list = {
		25 = { add_trait = physique_bad_3 }
		25 = { add_trait = physique_bad_2 }
		25 = { add_trait = physique_bad_1 }
		25 = { add_trait = beauty_bad_3 }
		25 = { add_trait = beauty_bad_2 }
		25 = { add_trait = beauty_bad_1 }
		5 = { add_trait = incapable }
		5 = { add_trait = one_legged }
		5 = { add_trait = hunchbacked }
		5 = { add_trait = clubfooted }
		5 = { add_trait = disfigured }
	}
}

# Save Clone Stat Spread
cl_save_stats_var_effect = {
	# Check if stat variable exists in cloning story
	if = {
		limit = {
			exists = this
			exists = scope:story
			scope:story ?= { has_variable = cl_$STAT$ }
		}
		# If yes, set it on our char
		set_variable = {
			name = cl_$STAT$
			value = scope:story.var:cl_$STAT$
		}
	}
	else = {
		# If no, set it on our char as 1
		set_variable = {
			name = cl_$STAT$
			value = 1
		}
	}
}

# Save Congenital on char as scope
cl_save_congenital_trait_effect = {
	# Spits out a trait_$TRAIT$ scope based on our congenital trait level
	# Example: scope:trait_arcana = trait:trait_arcana_bad_2
	# If we have none, use $TRAIT$_good_1
	# For localization
	if = {
		limit = { has_trait = $TRAIT$_good_1 }
		trait:$TRAIT$_good_1 = { save_scope_as = trait_$TRAIT$ }
	}
	else_if = {
		limit = { has_trait = $TRAIT$_good_2 }
		trait:$TRAIT$_good_2 = { save_scope_as = trait_$TRAIT$ }
	}
	else_if = {
		limit = { has_trait = $TRAIT$_good_3 }
		trait:$TRAIT$_good_3 = { save_scope_as = trait_$TRAIT$ }
	}
	else_if = {
		limit = { has_trait = $TRAIT$_bad_1 }
		trait:$TRAIT$_bad_1 = { save_scope_as = trait_$TRAIT$ }
	}
	else_if = {
		limit = { has_trait = $TRAIT$_bad_2 }
		trait:$TRAIT$_bad_2 = { save_scope_as = trait_$TRAIT$ }
	}
	else_if = {
		limit = { has_trait = $TRAIT$_bad_3 }
		trait:$TRAIT$_bad_3 = { save_scope_as = trait_$TRAIT$ }
	}
	else = { trait:$TRAIT$_good_1 = { save_scope_as = trait_$TRAIT$ }}
}

# Improve Clone congenital trait
cl_improve_clone_congenital_effect = {
	# Check if we had a successful improve congenital event (life_extension.0153)
	if = {
		limit = {
			scope:story ?= { has_variable = cl_congenital_$TRAIT$ }
		}
		# Save old trait as scope for loc
		if = {
			limit = { has_trait = $TRAIT$_good_1 }
			trait:$TRAIT$_good_1 = { save_scope_as = old_trait_$TRAIT$ }
		}
		else_if = {
			limit = { has_trait = $TRAIT$_good_2 }
			trait:$TRAIT$_good_2 = { save_scope_as = old_trait_$TRAIT$ }
		}
		else_if = {
			limit = { has_trait = $TRAIT$_good_3 }
			trait:$TRAIT$_good_3 = { save_scope_as = old_trait_$TRAIT$ }
		}
		else_if = {
			limit = { has_trait = $TRAIT$_bad_1 }
			trait:$TRAIT$_bad_1 = { save_scope_as = old_trait_$TRAIT$ }
		}
		else_if = {
			limit = { has_trait = $TRAIT$_bad_2 }
			trait:$TRAIT$_bad_2 = { save_scope_as = old_trait_$TRAIT$ }
		}
		else_if = {
			limit = { has_trait = $TRAIT$_bad_3 }
			trait:$TRAIT$_bad_3 = { save_scope_as = old_trait_$TRAIT$ }
		}
		# Save improved trait as scope for loc
		# Bad traits have a chance to improve two levels at once
		# Good traits can only improve one level
		random_list = {
			# Bad 2
			10 = {
				trigger = { has_trait = $TRAIT$_bad_3 }
				trait:$TRAIT$_bad_2 = { save_scope_as = new_trait_$TRAIT$ }
			}
			# Bad 1
			10 = {
				trigger = {
					OR = {
						has_trait = $TRAIT$_bad_3
						has_trait = $TRAIT$_bad_2
					}
				}
				trait:$TRAIT$_bad_1 = { save_scope_as = new_trait_$TRAIT$ }
			}
			# None
			10 = {
				trigger = {
					OR = {
						has_trait = $TRAIT$_bad_2
						has_trait = $TRAIT$_bad_1
					}
				}
				# New trait rank 0, aka nothing
			}
			# Good 1
			10 = {
				trigger = {
					OR = {
						has_trait = $TRAIT$_bad_1
						NOR = { # None
							has_trait = $TRAIT$_bad
							has_trait = $TRAIT$_good
						}
					}
				}
				trait:$TRAIT$_good_1 = { save_scope_as = new_trait_$TRAIT$ }
			}
			# Good 2
			10 = {
				trigger = {
					has_trait = $TRAIT$_good_1
				}
				trait:$TRAIT$_good_2 = { save_scope_as = new_trait_$TRAIT$ }
			}
			# Good 3
			10 = {
				trigger = {
					has_trait = $TRAIT$_good_2
				}
				trait:$TRAIT$_good_3 = { save_scope_as = new_trait_$TRAIT$ }
			}
		}
		# Remove old trait
		if = {
			limit = { exists = scope:old_trait_$TRAIT$ }
			remove_trait = scope:old_trait_$TRAIT$
		}
		# Add new trait
		if = {
			limit = { exists = scope:new_trait_$TRAIT$ }
			add_trait = scope:new_trait_$TRAIT$
		}
	}
}

# Small chance to improve Creator congenital upon cannibalizing the clone
@cl_improve_trait_chance = 5
cl_improve_creator_congenital_effect = { #TBD: Test
	# If trait bad, make better
	if = {
		limit = {
			scope:clone = { has_trait = $TRAIT$_good }
			has_trait = $TRAIT$_bad_3
		}
		random = {
			chance = @cl_improve_trait_chance
			remove_trait = $TRAIT$_bad_3
			add_trait = $TRAIT$_bad_2
		}
	}
	else_if = {
		limit = {
			scope:clone = { has_trait = $TRAIT$_good }
			has_trait = $TRAIT$_bad_2
		}
		random = {
			chance = @cl_improve_trait_chance
			remove_trait = $TRAIT$_bad_2
			add_trait = $TRAIT$_bad_1
		}
	}
	else_if = {
		limit = {
			scope:clone = { has_trait = $TRAIT$_good }
			has_trait = $TRAIT$_bad_1
		}
		random = {
			chance = @cl_improve_trait_chance
			remove_trait = $TRAIT$_bad_1
		}
	}
	# If no trait, make good
	else_if = {
		limit = {
			scope:clone = { has_trait = $TRAIT$_good }
			NOT = { has_trait = $TRAIT$_good }
		}
		random = {
			chance = @cl_improve_trait_chance
			add_trait = $TRAIT$_good_1
		}
	}
	# If trait good, make better
	else_if = {
		limit = {
			scope:clone = {
				OR = {
					has_trait = $TRAIT$_good_3
					has_trait = $TRAIT$_good_2
				}
			}
			has_trait = $TRAIT$_good_1
		}
		random = {
			chance = @cl_improve_trait_chance
			remove_trait = $TRAIT$_good_1
			add_trait = $TRAIT$_good_2
		}
	}
	else_if = {
		limit = {
			scope:clone = {
				has_trait = $TRAIT$_good_3
			}
			has_trait = $TRAIT$_good_2
		}
		random = {
			chance = @cl_improve_trait_chance
			remove_trait = $TRAIT$_good_2
			add_trait = $TRAIT$_good_3
		}
	}
}

# Necromancy Story Effects
start_story_cycle_learn_necromancy_effect = {
	show_as_tooltip = {
		add_character_modifier = learning_necromancy
	}
	hidden_effect = {
		create_story = story_cycle_learn_necromancy
	}
}

end_story_cycle_learn_necromancy_effect = {
	show_as_tooltip = {
		remove_character_modifier = learning_necromancy
	}
    scope:story = {
		hidden_effect = { end_story = yes }
	}
}

purchase_writ_of_war_effect = {
	custom_tooltip = buy_writ_of_war_interaction_effect_tooltip
	if = {
		limit = {
			highest_held_title_tier = tier_county
		}	
		remove_short_term_gold = 100
	}
	else_if = {
		limit = {
			highest_held_title_tier = tier_duchy
		}	
		remove_short_term_gold = 200
	}
	else_if = {
		limit = {
			highest_held_title_tier = tier_kingdom
		}	
		remove_short_term_gold = 300
	}
	hidden_effect = {
		add_character_flag = {
			flag = has_writ_of_war
			years = 5
		}
	}
}

distribute_akaviri_ethnicity = { #Distribute akaviri ethnicity for imperial akaviri families
	dynasty:$DYNASTY$ = {
		every_dynasty_member = {
			even_if_dead = yes
			limit = {
				NOT = { culture = culture:ilniviri } #Already have ethnicity
			}
			every_ancestor = {
				even_if_dead = yes
				limit = {
					dynasty = dynasty:$DYNASTY$
					NOT = { culture = culture:ilniviri } #Already have ethnicity
				}
				add_to_list = akaviri_family_member
				every_ancestor = {
					even_if_dead = yes
					limit = {
						dynasty = dynasty:$DYNASTY$
						NOT = { culture = culture:ilniviri } #Already have ethnicity
					}
					add_to_list = akaviri_family_member
					every_ancestor = {
						even_if_dead = yes
						limit = {
							dynasty = dynasty:$DYNASTY$
							NOT = { culture = culture:ilniviri } #Already have ethnicity
						}
						add_to_list = akaviri_family_member
						every_ancestor = {
							even_if_dead = yes
							limit = {
								dynasty = dynasty:$DYNASTY$
								NOT = { culture = culture:ilniviri } #Already have ethnicity
							}
							add_to_list = akaviri_family_member
							every_ancestor = {
								even_if_dead = yes
								limit = {
									dynasty = dynasty:$DYNASTY$
									NOT = { culture = culture:ilniviri } #Already have ethnicity
								}
								add_to_list = akaviri_family_member
							}
						}
					}
				}
			}
		}
	}
	dynasty:$DYNASTY$ = {
		# Current alive members
		every_dynasty_member = {
			limit = {
				NOT = { culture = culture:ilniviri } #Already have ethnicity
				NOT = {
					any_in_list = {
						list = akaviri_family_member
						this = prev
					}
				}
			}
			add_to_list = akaviri_family_member
		}
	}
	hidden_effect = {
		every_in_list = {
			list = akaviri_family_member
			random_list = {
				1 = { set_ethnicity = race_akaviri_rimmen_1 }
				1 = { set_ethnicity = race_akaviri_rimmen_2 }
				1 = { set_ethnicity = race_akaviri_rimmen_3 }
				1 = { set_ethnicity = race_akaviri_rimmen_4 }
			}
		}
	}
}

nibenese_ethnicity_distribution = {
	this = {
		random_list = {
			1 = { set_ethnicity = race_imperial_nibenese_1 }
			1 = { set_ethnicity = race_imperial_nibenese_2 }
			1 = { set_ethnicity = race_imperial_nibenese_3 }
			1 = { set_ethnicity = race_imperial_nibenese_4 }
			1 = { set_ethnicity = race_imperial_nibenese_5 }
			1 = { set_ethnicity = race_imperial_nibenese_6 }
			1 = { set_ethnicity = race_imperial_nibenese_1_dark }
			1 = { set_ethnicity = race_imperial_nibenese_2_dark }
			1 = { set_ethnicity = race_imperial_nibenese_3_dark }
			1 = { set_ethnicity = race_imperial_nibenese_4_dark }
		}
	}
}

pre_akaviri_nibenese_fix = {
	character:alessian_105 = { nibenese_ethnicity_distribution = yes }
	character:alessian_107 = { nibenese_ethnicity_distribution = yes }
	character:alessian_108 = { nibenese_ethnicity_distribution = yes }
	character:alessian_109 = { nibenese_ethnicity_distribution = yes }
	character:alessian_contest_1 = { nibenese_ethnicity_distribution = yes }
	character:tharn_3 = { nibenese_ethnicity_distribution = yes }
	character:tharn_3_line = { nibenese_ethnicity_distribution = yes }
	character:tharn_4 = { nibenese_ethnicity_distribution = yes }
	character:tharn_4_line = { nibenese_ethnicity_distribution = yes }
	character:tharn_5 = { nibenese_ethnicity_distribution = yes }
	character:tharn_6 = { nibenese_ethnicity_distribution = yes }
	character:tharn_7 = { nibenese_ethnicity_distribution = yes }
	character:tasus_1 = { nibenese_ethnicity_distribution = yes }
	character:tasus_2 = { nibenese_ethnicity_distribution = yes }
	character:tasus_3 = { nibenese_ethnicity_distribution = yes }
	character:verol_1 = { nibenese_ethnicity_distribution = yes }
	character:verol_2 = { nibenese_ethnicity_distribution = yes }
	character:verol_2b = { nibenese_ethnicity_distribution = yes }
	character:verol_3 = { nibenese_ethnicity_distribution = yes }
	character:verol_3b = { nibenese_ethnicity_distribution = yes }
	character:verol_4 = { nibenese_ethnicity_distribution = yes }
	character:verol_5 = { nibenese_ethnicity_distribution = yes }
	character:verol_6 = { nibenese_ethnicity_distribution = yes }
	character:verol_7 = { nibenese_ethnicity_distribution = yes }
	character:verol_8 = { nibenese_ethnicity_distribution = yes }
	character:leyawiin_random_1 = { nibenese_ethnicity_distribution = yes }
	character:zinius_001 = { nibenese_ethnicity_distribution = yes }
	character:cosmas_001 = { nibenese_ethnicity_distribution = yes }
}