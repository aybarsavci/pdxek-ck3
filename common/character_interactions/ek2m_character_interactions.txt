# ek2m interaction - allows players to join any war
join_war_interaction = {
	category = interaction_category_diplomacy
	interface = interfere_in_war
	special_interaction = interfere_in_war_interaction
	popup_on_receive = yes
	desc = join_war_interaction_desc
	icon = alliance
	interface_priority = 29

	greeting = positive
	notification_text = join_war_interaction_notification

	is_shown = {
		scope:actor = {
			is_ai = no
		}
		scope:recipient = {
			is_at_war = yes
			NOR = {
				this = scope:actor
				is_at_war_with = scope:actor
			}
		}
	}

	is_valid_showing_failures_only = {

		# recipient is not in (any) war against your liege(s) or suzerain(s)
		trigger_if = {
			limit = { exists = scope:actor.liege }
			custom_description = {
				text = join_war_interaction_recipient_warring_with_my_liege
				subject = scope:recipient
				scope:actor = {
					NOT = {
						any_liege_or_above = {
							is_at_war_with = scope:recipient
						}
					}
				}
			}
		}

		# if the target is neither a vassal-or-below, nor a liege-or-above, the recipient must either be an ally or defending against a qualifying holy war - unless the character is an adventurer in which case other rules apply
		trigger_else_if = {
			limit = {
				scope:actor = {
					NOT = { target_is_liege_or_above = scope:recipient }
				}
			}
			trigger_if = {
				limit = {
					scope:actor = { is_landless_adventurer = yes }
				}
				# bypass the requirements, unless you were invloved in a war and decided to leave it
				scope:recipient = {
					trigger_if = {
						limit = {
							any_character_war = {
								has_variable_list = left_voluntarily
							}
						}
						custom_tooltip = {
							text = laamp_war_change_sides_interaction.left_voluntarily
							is_target_in_variable_list = {
								name = left_voluntarily
								target = scope:actor	
							}
						}
					}
				}
			}
			trigger_else_if = {
				limit = {
					scope:recipient = {
						any_character_war = {
							#Must be either the same faith as the character being holy warred...
							scope:recipient.faith = scope:actor.faith
							#... Or, same religion, *and* you couldn't holy war them yourself.
							AND = {
								scope:recipient.faith.religion = scope:actor.faith.religion
								scope:actor.faith = {
									faith_hostility_level = {
										target = scope:recipient.faith
										value < religious_cb_enabled_hostility_level
									}
								}
							}
							any_war_defender = { this = scope:recipient }
						}
					}
				}
				# Deliberately blank; we've passed the trigger and making a desc out of this doesn't make sense
			}
		}

		# recipient is liege
		trigger_else = {
			custom_description = {
				text = join_war_interaction_recipient_not_liege
				subject = scope:recipient
				scope:actor = {
					target_is_liege_or_above = scope:recipient
				}
			}
		}
	}
	
	can_be_picked = {
		scope:target ?= {

			# recipient is war leader
			is_war_leader = scope:recipient

			#allow laamp_join_war_contract to bypass the requirements
			trigger_if = {
				limit = {
					scope:actor = {
						is_landless_adventurer = yes
					}
				}
			}

			# If not holy war, special exception for liege trying to put down his vassal's peasant revolt.	
			trigger_else_if = {
				limit = {
					is_religious_war = no
					scope:actor = { target_is_vassal_or_below = scope:recipient }
					primary_defender = scope:recipient
					primary_attacker = {
						is_leading_faction_type = peasant_faction
					}
				}
				always = yes
			}

			# making the default behavior explicit if no other trigger_(else_)ifs are valid
			trigger_else = {
				always = yes
			}
		}

		joiner_not_already_in_another_war_with_any_target_war_participants_trigger = {
			WARRIOR = scope:recipient
			JOINER = scope:actor
		}
	}

	is_highlighted = {
		scope:actor = {
			any_character_task_contract = {		
				has_task_contract_type = laamp_join_war_contract
				task_contract_employer = scope:recipient
			}
		}
	}

	on_accept = {
		scope:target ?= {
			hidden_effect = {
				set_called_to = scope:actor
			}
			if = {
				limit = { is_attacker = scope:recipient }
				add_attacker = scope:actor
				if = {
					limit = {
						OR = {
							scope:actor = {
								any_home_court_hostage = {
									warden ?= { is_defender_in_war = scope:target }
								}
							}
							scope:target = {
								any_war_defender = {
									any_warden_hostage = { home_court ?= scope:actor }
								}
							}
						}
					}
					custom_tooltip = hostage_execution_warning_tt
				}
			}
			else = {
				add_defender = scope:actor
				if = {
					limit = {
						OR = {
							scope:actor = {
								any_home_court_hostage = {
									warden ?= { is_attacker_in_war = scope:target }
								}
							}
							scope:target = {
								any_war_attacker = {
									any_warden_hostage = { home_court ?= scope:actor }
								}
							}
						}
					}
					custom_tooltip = hostage_execution_warning_tt
				}
			}
			if = {
				limit = {
					is_religious_war = yes
					scope:actor = {
						any_active_accolade = {
							has_accolade_parameter = acclaimed_knight_piety_from_battle
						}
					}
				}
				scope:actor = {
					add_piety = medium_piety_gain
				}
			}
			if = {
				limit = {
					is_religious_war = yes
					scope:actor = {
						any_active_accolade = {
							has_accolade_parameter = acclaimed_knight_piety_from_battle_high
						}
					}
				}
				scope:actor = {
					add_piety = major_piety_gain
				}
			}
		}
		scope:actor = {
			stress_impact = {
				craven = medium_stress_impact_gain
			}
			add_to_variable_list = {
				name = joined_as_ally
				target = scope:target
			}
		}
		scope:recipient = {
			show_as_tooltip = {
				if = {
					limit = {
						is_ai = yes
					}
					progress_towards_friend_effect = {
						CHARACTER = scope:actor
						OPINION = 0
						REASON = friend_alliance
					}
				}
				else = {
					hidden_effect = { #To nudge friendship
						if = {
							limit = {
								NOR = {
									has_relation_friend = scope:actor
									has_relation_potential_friend = scope:actor
								}
							}
							set_relation_potential_friend = scope:actor
						}
					}
				}
			}
		}

		# If we're a clan this interaction affects unity - but only when we attemp to aid a house member against a non-house member
		if = {
			limit = {
				exists = scope:target
				scope:target = {
					OR = {
						AND = {
							primary_attacker = scope:recipient
							scope:recipient.house = scope:actor.house
							primary_defender = {
								NOT = { house = scope:actor.house }
							}
						}
						AND = {
							primary_defender = scope:recipient
							scope:recipient.house = scope:actor.house
							primary_attacker = {
								NOT = { house = scope:actor.house }
							}
						}
					}
				}
			}
			add_clan_unity_interaction_effect = {
				CHARACTER = scope:actor
				TARGET = scope:recipient
				VALUE = medium_unity_gain
				DESC = clan_unity_join_war.desc
				REVERSE_NON_HOUSE_TARGET = no
			}
		}
	}

	on_decline = {
		scope:actor = {
			trigger_event = char_interaction.0236
		}
	}

	auto_accept = yes

	ai_accept = {
		base = 100 # everyone wants help
	}
}