
namespace = ek_faction_demand

# Crisis Faction Demand
# by Henrik Fåhraeus and Sean Hughes
ek_faction_demand.1001 = {
	type = letter_event
	sender = scope:peasant_leader
	opening = {
		desc = "FACTION_DEMAND_EK_CRISIS"
	}
	desc = {
		first_valid = {
			triggered_desc = {
				trigger = {
					scope:faction.var:crisis_type = flag:bandits_flag
				}
				desc = "FACTION_DEMAND_EK_CRISIS_DESC_BANDITS"
			}
			triggered_desc = {
				trigger = {
					scope:faction.var:crisis_type = flag:goblinken_flag
				}
				desc = "FACTION_DEMAND_EK_CRISIS_DESC_GOBLINS"
			}
			triggered_desc = {
				trigger = {
					scope:faction.var:crisis_type = flag:necromancers_flag
				}
				desc = "FACTION_DEMAND_EK_CRISIS_DESC_NECROMANCERS"
			}
			triggered_desc = {
				trigger = {
					scope:faction.var:crisis_type = flag:vampires_flag
				}
				desc = "FACTION_DEMAND_EK_CRISIS_DESC_VAMPIRES"
			}
			triggered_desc = {
				trigger = {
					scope:faction.var:crisis_type = flag:werewolves_flag
				}
				desc = "FACTION_DEMAND_EK_CRISIS_DESC_WEREWOLVES"
			}
			triggered_desc = {
				trigger = {
					scope:faction.var:crisis_type = flag:falmer_flag
				}
				desc = "FACTION_DEMAND_EK_CRISIS_DESC_FALMER"
			}
			triggered_desc = {
				trigger = {
					scope:faction.var:crisis_type = flag:imga_flag
				}
				desc = "FACTION_DEMAND_EK_CRISIS_DESC_IMGA"
			}
			triggered_desc = {
				trigger = {
					scope:faction.var:crisis_type = flag:peryite_flag
				}
				desc = "FACTION_DEMAND_EK_CRISIS_DESC_PERYITE"
			}
			triggered_desc = {
				trigger = {
					scope:faction.var:crisis_type = flag:daedra_flag
				}
				desc = "FACTION_DEMAND_EK_CRISIS_DESC_DAEDRA"
			}
			triggered_desc = {
				trigger = {
					scope:faction.var:crisis_type = flag:ashlanders_flag
				}
				desc = "FACTION_DEMAND_EK_CRISIS_DESC_ASHLANDERS"
			}
			triggered_desc = {
				trigger = {
					scope:faction.var:crisis_type = flag:slaves_flag
				}
				desc = "FACTION_DEMAND_EK_CRISIS_DESC_SLAVES"
			}
			desc = "FACTION_DEMAND_EK_CRISIS_DESC"
		}
	}

	trigger = {
		exists = scope:faction
		exists = scope:peasant_leader
		scope:peasant_leader.joined_faction = scope:faction
	}

	on_trigger_fail = {
		debug_log = "Popular Faction tried to press claim (probably) without existing peasant_leader"
		debug_log_scopes = yes
		debug_log = "Popular Faction error reporting complete"
	}

	immediate = {
		every_realm_province = {
			county = { add_to_list = remaining_counties_list }
		}
		scope:faction = {
			every_faction_county_member = { remove_from_list = remaining_counties_list }
		}
	}

	# Option B: Grant the faction independence.
	option = {
		name = "FACTION_DEMAND_EK_CRISIS_ACCEPT_GRANT_INDEPENDENCE"
		trigger = { # AI should not give the faction independence if a player is targeted by the faction.
			NAND = {
				scope:faction = {
					has_variable = faction_targets_player
				}
				is_ai = yes
			}
		}
		
		# This effect should always be placed here, _before_ all the other effects in the block.
		trigger_event = { on_action = on_faction_demand_accepted }
		
		add_prestige_level = -1
		if = {
			limit = {
				dread > 0
			}
			add_dread = medium_dread_loss
		}

		scope:peasant_leader = {
			ek_faction_leader_victory_effect = yes #fire necessary effects for the victor
		}

		successful_popular_revolt_outcome_effect = {
			FACTION_LEADER = scope:peasant_leader
			TARGET_TITLE = scope:target_title
			SOURCE_GOVERNMENT = root
		}

		# If the faction includes ALL of our counties, notify the player that it will leave them landless!
		if = {
			limit = {
				any_in_list = {
					list = remaining_counties_list
					count < 1
				}
			}
			custom_tooltip = FACTION_DEMAND_EK_CRISIS_ACCEPT_GRANT_INDEPENCE_TT
		}

		# Struggle Catalysts.
		# Should rename the Catalysts?
		if = {
			limit = {
				is_important_or_vip_struggle_character = yes
				any_character_struggle = {
					involvement = involved
					activate_struggle_catalyst_secondary_character_involvement_either_trigger = {
						CATALYST = catalyst_accepted_demand_from_faction_requesting_culture_faith_conversion
						CHAR = scope:faction_leader
					}
				}
			}
			every_character_struggle = {
				involvement = involved
				limit = {
					activate_struggle_catalyst_secondary_character_involvement_either_trigger = {
						CATALYST = catalyst_accepted_demand_from_faction_requesting_culture_faith_conversion
						CHAR = scope:faction_leader
					}
				}
				activate_struggle_catalyst = {
					catalyst = catalyst_accepted_demand_from_faction_requesting_culture_faith_conversion
					character = root
				}
			}
		}

		hidden_effect = {
			if = {
				limit = {
					exists = scope:faction
				}
				scope:faction = {
					clean_revolt_county_modifiers_from_faction_members_effect = yes
					destroy_faction = yes
				}
			}
		}

		ai_chance = {
			base = 0
			compare_modifier = { # Stronger factions increase the chance of an AI ruler capitulating; at 200% ruler army strength, this maxes out at +50% chance to accept demands.
				value = {
					value = scope:faction.faction_power
					subtract = 100
					multiply = 0.5
				}
				max = 50
			}
			compare_modifier = { # Craven rulers can get up to +37% chance to accept demands.
				value = ai_boldness
				multiplier = -0.5
			}
			modifier = {
				factor = 0.1
				any_ally = {
					NOR = {
						target_is_liege_or_above = root
						target_is_vassal_or_below = root
					}
					max_military_strength > root.max_military_strength
				}
			}
			compare_modifier = {
				value = debt_level
				multiplier = 25
			}
			modifier = {
				add = -50
				is_at_war = no
				primary_title.tier >= tier_kingdom
			}
			modifier = {
				add = -150
				is_at_war = no
				primary_title.tier >= tier_empire
			}
		}
	}
	
	# Option C: Refuse the demand and start a war.
	option = {
		name = "FACTION_DEMAND_EK_CRISIS_REFUSE"

		# This effect should always be placed here, _before_ all the other effects in the block.
		trigger_event = { on_action = on_faction_demand_rejected }

		scope:faction = {
			faction_start_war = {
				title = scope:target_title
			}
		}
		
		custom_tooltip = FACTION_DEMAND_EK_CRISIS_REFUSE_TT
		
		if = { # Send follow up event to affected vassals.
			limit = {
				list_size = {
					name = crisis_faction_vassal_targets
					value > 0
				}
			}
			every_in_list = {
				list = crisis_faction_vassal_targets
				trigger_event = ek_faction_demand.0099
			}
		}

		ai_chance = {
			base = 100
			compare_modifier = { # Weaker factions increase the chance of an AI ruler refusing; at 80% army strength (minimum), this will be +20; at 200% army strength, this will max out at -50.
				value = {			
					value = scope:faction.faction_power
					subtract = 100
					multiply = -1
				}
				min = -50
			}
			compare_modifier = { # Brave rulers get up to a 50% bonus chance to refuse.
				value = ai_boldness
				multiplier = -0.5
				min = -50
			}
			modifier = {
				factor = 1.5
				any_ally = {
					NOR = {
						target_is_liege_or_above = root
						target_is_vassal_or_below = root
					}
					max_military_strength > root.max_military_strength
				}
			}
			compare_modifier = {
				value = debt_level
				multiplier = -25
			}
		}
	}
	
	after = {
		if = {
			limit = {
				exists = scope:faction
				scope:faction = {
					has_variable = faction_targets_player
				}
			}
			scope:faction = {
				remove_variable = faction_targets_player
			}
		}
	}
}

# Populist Faction Demand - Affected vassals choose their action
ek_faction_demand.0099 = {
	type = letter_event
	sender = scope:peasant_leader
	opening = {
		desc = "FACTION_DEMAND_EK_CRISIS"
	}
	desc = {
		first_valid = {
			triggered_desc = {
				trigger = {
					scope:faction.var:crisis_type = flag:bandits_flag
				}
				desc = "FACTION_DEMAND_EK_CRISIS_DESC_BANDITS"
			}
			triggered_desc = {
				trigger = {
					scope:faction.var:crisis_type = flag:goblinken_flag
				}
				desc = "FACTION_DEMAND_EK_CRISIS_DESC_GOBLINS"
			}
			triggered_desc = {
				trigger = {
					scope:faction.var:crisis_type = flag:necromancers_flag
				}
				desc = "FACTION_DEMAND_EK_CRISIS_DESC_NECROMANCERS"
			}
			triggered_desc = {
				trigger = {
					scope:faction.var:crisis_type = flag:vampires_flag
				}
				desc = "FACTION_DEMAND_EK_CRISIS_DESC_VAMPIRES"
			}
			triggered_desc = {
				trigger = {
					scope:faction.var:crisis_type = flag:werewolves_flag
				}
				desc = "FACTION_DEMAND_EK_CRISIS_DESC_WEREWOLVES"
			}
			triggered_desc = {
				trigger = {
					scope:faction.var:crisis_type = flag:falmer_flag
				}
				desc = "FACTION_DEMAND_EK_CRISIS_DESC_FALMER"
			}
			triggered_desc = {
				trigger = {
					scope:faction.var:crisis_type = flag:imga_flag
				}
				desc = "FACTION_DEMAND_EK_CRISIS_DESC_IMGA"
			}
			triggered_desc = {
				trigger = {
					scope:faction.var:crisis_type = flag:peryite_flag
				}
				desc = "FACTION_DEMAND_EK_CRISIS_DESC_PERYITE"
			}
			triggered_desc = {
				trigger = {
					scope:faction.var:crisis_type = flag:daedra_flag
				}
				desc = "FACTION_DEMAND_EK_CRISIS_DESC_DAEDRA"
			}
			triggered_desc = {
				trigger = {
					scope:faction.var:crisis_type = flag:ashlanders_flag
				}
				desc = "FACTION_DEMAND_EK_CRISIS_DESC_ASHLANDERS"
			}
			triggered_desc = {
				trigger = {
					scope:faction.var:crisis_type = flag:slaves_flag
				}
				desc = "FACTION_DEMAND_EK_CRISIS_DESC_SLAVES"
			}
			desc = "FACTION_DEMAND_EK_CRISIS_DESC"
		}
	}

	trigger = {
		exists = scope:faction
		exists = scope:peasant_leader
		scope:peasant_leader.joined_faction = scope:faction
	}
	
	immediate = {
		scope:faction.faction_war = {
			save_scope_as = populist_war
		}
	}
	
	# Option A: Convert to the faction's culture/faith and join the rebels.
	option = {
		name = {
			trigger = {
				culture = scope:peasant_leader.culture
				faith = scope:peasant_leader.faith
			}
			text = "FACTION_DEMAND_EK_CRISIS_VASSAL_JOIN_REBELS"
		}
		name = {
			trigger = {
				NAND = {
					culture = scope:peasant_leader.culture
					faith = scope:peasant_leader.faith
				}
			}
			text = "FACTION_DEMAND_EK_CRISIS_VASSAL_CONVERTS"
		}
		trigger = {
			# Have to be of the same faith as the faction, or the faith must have a large enough presence in the vassal's realm.
			OR = {
				faith = scope:peasant_leader.faith
				any_realm_province = {
					percent >= 0.20
					faith = scope:peasant_leader.faith
				}
			}
			
			# Heads of Faith can never convert.
			NOT = { faith.religious_head = root }

			#some restrictions must apply in EK to avoid goblin culture Altmer and Argonian culture Cyrodiilics
			culture = { has_same_culture_heritage = scope:peasant_leader.culture }
			
			# Restrictions to stop the AI converting quite so freely
			trigger_if = {
				limit = {
					is_ai = yes
				}
				
				# May not convert to an unreformed faith from a reformed one.
				NAND = {
					scope:peasant_leader.faith = { has_doctrine = unreformed_faith_doctrine }
					faith = {
						NOT = { has_doctrine = unreformed_faith_doctrine }
					}
				}
				
				# Must be converting from a low-fervor faith to a higher-fervor faith.
				scope:peasant_leader.faith = { fervor >= 31 }
				faith = { fervor <= 30 }
				
				# Zealous rulers do not get the option to change faith.
				OR = {
					NOT = { has_trait = zealous }
					faith = scope:peasant_leader.faith
				}
				
				# Crusaders & Crusader-Monarchs should never accept this.
				NOR = {
					has_trait = faith_warrior
					has_trait = crusader_king
					#has_title = title:k_jerusalem
				}
			}
			
			# You cannot join the attacking side if you already are at war with another participant.
			scope:faction.faction_war = {
				NOT = {
					any_war_participant = {
						is_at_war_with = root
					}
				}
			}
			
			# You cannot join the attacking side if it would put you against someone you are fighting another war with.
			scope:faction.faction_war = {
				NOT = {
					any_war_defender = {
						any_war_ally = {
							this = root
						}
					}
				}
			}
		}
		if = {
			limit = {
				NOT = { faith = scope:peasant_leader.faith }
			}
			set_character_faith = scope:peasant_leader.faith
			add_piety_level = -1
		}
		
		# Join the war.
		scope:faction.faction_war = {
			add_attacker = root
		}
		custom_tooltip = FACTION_DEMAND_EK_CRISIS_VASSAL_CONVERTS_TT
		
		stress_impact = {
			zealous = massive_stress_gain
		}
		
		ai_chance = {
			base = 0
			
			# Want to convert for cultural reasons
			modifier = {
				add = 10
				OR = {
					AND = {
						culture = scope:peasant_leader.culture
						NOT = { culture = scope:faction_target.culture }
					}
					AND = {
						any_realm_province = {
							percent >= 0.40
							culture = scope:peasant_leader.culture
						}
						NOT = { culture = scope:faction_target.culture }
					}
				}
			}
			modifier = {
				factor = 0
				culture = { has_cultural_tradition = tradition_staunch_traditionalists }
				NOT = { culture = scope:faction_target.culture }
			}
			
			# Want to convert for religious reasons
			modifier = {
				add = 20
				OR = {
					AND = {
						faith = scope:peasant_leader.faith
						NOT = { faith = scope:faction_target.faith }
					}
					AND = {
						any_realm_province = {
							percent >= 0.40
							faith = scope:peasant_leader.faith
						}
						NOT = { faith = scope:faction_target.faith }
					}
				}
			}
			modifier = {
				factor = 0
				culture = { has_cultural_tradition = tradition_zealous_people }
				NOT = { faith = scope:peasant_leader.faith }
			}
			modifier = {
				factor = 1.5
				culture = { has_cultural_tradition = tradition_religion_blending }
			}
			modifier = {
				factor = 2
				has_trait = zealous
				faith = scope:peasant_leader.faith
			}
			
			# General modifiers
			modifier = {
				factor = 1.25
				has_trait = fickle
			}
		}
	}
	
	# Option B: Fight alongside your liege.
	option = {
		name = FACTION_DEMAND_EK_CRISIS_VASSAL_JOIN_WAR
		
		# You cannot join the defending side...
		trigger = {
			custom_tooltip = { # ... If you already are at war with another participant.
				text = FACTION_DEMAND_EK_CRISIS_VASSAL_JOIN_WAR_BLOCK_TT
				scope:faction.faction_war = {
					NOT = {
						any_war_participant = {
							is_at_war_with = root
						}
					}
				}
			}
			custom_tooltip = { # ... If it would put you against someone you are fighting another war with.
				text = FACTION_DEMAND_EK_CRISIS_VASSAL_JOIN_WAR_BLOCK_TT_2
				scope:faction.faction_war = {
					NOT = {
						any_war_attacker = {
							any_war_ally = {
								this = root
							}
						}
					}
				}
			}
		}
		show_as_unavailable = {
			OR = {
				scope:faction.faction_war = {
					any_war_participant = {
						is_at_war_with = root
					}
				}
				scope:faction.faction_war = {
					any_war_attacker = {
						any_war_ally = {
							this = root
						}
					}
				}
			}
		}
		
		# Join the war.
		scope:faction.faction_war = {
			add_defender = root
		}
		custom_tooltip = FACTION_DEMAND_EK_CRISIS_VASSAL_JOIN_WAR_TT
		
		ai_chance = {
			base = 100
		}
	}
	
	# Option C: Do nothing.
	option = {
		name = FACTION_DEMAND_EK_CRISIS_VASSAL_TAKE_NO_SIDE
		custom_tooltip = FACTION_DEMAND_EK_CRISIS_VASSAL_TAKE_NO_SIDE_TT_A
		custom_tooltip = FACTION_DEMAND_EK_CRISIS_VASSAL_TAKE_NO_SIDE_TT_B
		
		ai_chance = {
			base = 0
			
			modifier = {
				add = 20
				has_trait = craven
			}
		}
	}
}

# Spawn rebel reinforcements for popular revolts which successfully capture holdings.
ek_faction_demand.1010 = {
	hidden = yes

	trigger = {
		exists = joined_faction
		joined_faction = { 
			faction_is_type = ek_crisis_faction
			has_variable = crisis_type 
		}
		exists = scope:war
		scope:war = {
			primary_defender = scope:previous_controller
		}
	}

	immediate = {
		joined_faction = { save_scope_as = ek_crisis_faction }
		# Determine how many rebel reinforcements we need to spawn, based on the total number of provinces captured.
		set_variable = {
			name = number_rebel_reinforcements
			value = {		
				add = {
					every_in_list = {
						list = occupied_baronies
						add = building_levies
					}
				}
				multiply = { # Only spawns between 25% and 50% of the total county's levies (otherwise could get too overwhelming).
					add = 0.25
					add = {
						scope:county = {
							add = development_level
							multiply = 0.0025
						}
					}	
				}
			}
		}

		# Spawn the army on the captured province.
		ek_crisis_faction_spawn_reinforcements_effect = { QUANTITY = var:number_rebel_reinforcements LOCATION = scope:barony.title_province }
		
		# Apply modifier
		if = {
			limit = {
				any_in_list = {
					list = occupied_baronies
					is_capital_barony = yes
				}
			}
			ek_crisis_faction_add_remove_relevant_modifier_to_county = { INPUT = scope:ek_crisis_faction.var:crisis_type OUTPUT = scope:county ACTION = add }
		}
		# Additional loss of county control, can be up to -50 for large counties.
		every_in_list = {
			list = occupied_baronies
			scope:county = {
				change_county_control = -10
			}
		}
	}

	after = {
		remove_variable = number_rebel_reinforcements
	}
}