
namespace = ek_transformation

################
# VAMPIRE EVENTS #
################

##############################################
######COVERT TO VAMPIRE SCHEME EVENTS######
##############################################

#Do I want to go ahead with this?
ek_transformation.2001 = {
	type = character_event
	content_source = dlc_ek
	title = ek_transformation.2001.t
	desc = {
		desc = ek_transformation.2001.start.desc
		first_valid = {
			triggered_desc = {
				trigger = { trait_is_shunned_or_criminal_in_my_or_lieges_faith_trigger = { TRAIT = vampire_character GENDER_CHARACTER = root } }
				desc = ek_transformation.2001.secrecy.desc
			}
			desc = ek_transformation.2001.no_secrecy.desc
		}
		desc = ek_transformation.2001.end.desc
	}
	theme = witchcraft
	override_background = {
		reference = sitting_room
	}
	left_portrait = scope:target
	
	#Yes
	option = {
		name = ek_transformation.2001.a
		custom_tooltip = ek_transformation.2001.a.tt

		if = {
			limit = { scope:target = { is_ai = no } }
			scope:target = {
				trigger_event = {
					id = ek_transformation.2002
					days = 3
				}
			}
		}
		else_if = {
			limit = { exists = scope:scheme_successful }
			trigger_event = {
				id = ek_transformation.2003
				days = 3
			}
		}
		else = {
			trigger_event = {
				on_action = convert_to_vampire_failure_outcome
				days = 3
			}
		}

		ai_chance = {
			base = 100
		}
	}

	#No
	option = {
		name = {
			trigger = {
				use_convert_to_vampire_secrecy_trigger = { OWNER = root }
			}
			text = ek_transformation.2001.b1
		}
		name = {
			trigger = {
				use_convert_to_vampire_secrecy_trigger = { OWNER = root }
			}
			text = ek_transformation.2001.b2
		}
		scope:scheme = {
			end_scheme = yes
		}

		ai_chance = {
			base = 0
		}
	}
}


#Someone is trying to convert me to become a vampire (player only)
ek_transformation.2002 = {
	type = character_event
	content_source = dlc_ek
	title = ek_transformation.2002.t
	desc = {
		desc = ek_transformation.2002.start.desc
		first_valid = {
			triggered_desc = {
				trigger = { exists = scope:scheme_discovered }
				desc = ek_transformation.2002.discovery.desc
			}
			desc = ek_transformation.2002.no_discovery.desc
		}
		desc = ek_transformation.2002.end.desc
	}
	theme = witchcraft
	override_background = {
		reference = sitting_room
	}
	left_portrait = {
		character = scope:left_portrait
		triggered_animation = {
			trigger = { scope:left_portrait = root }
			animation = disbelief
		}
		animation = personality_dishonorable
	}
	
	immediate = {
		if = {
			limit = { exists = scope:scheme_discovered }
			scope:owner = {
				save_scope_as = left_portrait
				show_as_tooltip = {
					random_secret = {
						limit = {
							secret_type = secret_vampire
							NOT = { is_known_by = root }
						}
						reveal_to = root
					}
				}
			}
		}
		else = {
			save_scope_as = left_portrait
		}
	}

	#Yes I want to be a vampire
	option = {
		name = ek_transformation.2002.a

		show_as_tooltip = {
			give_vampire_secret_or_trait_effect = yes
		}

		if = {
			limit = {
				faith = {
					NOT = { has_doctrine_parameter = vampirism_accepted }
				}
			}
			add_piety = medium_piety_loss
		}
		
		scope:owner = {
			trigger_event = ek_transformation.2003
		}

		stress_impact = {
			zealous = massive_stress_impact_gain
			craven = medium_stress_impact_gain
		}
	}

	#No I don't want to be a vampire
	option = {
		name = ek_transformation.2002.b

		add_piety = medium_piety_gain

		scope:owner = {
			trigger_event = ek_transformation.2004
		}

		if = {
			limit = { exists = scope:scheme_discovered }
			reverse_add_opinion = {
				target = scope:owner
				modifier = disappointed_opinion
				opinion = -15
			}
		}

		stress_impact = {
			ambitious = minor_stress_impact_gain
		}
	}
	
	#Reveal them to the world!
	option = {
		trigger = { exists = scope:scheme_discovered }
		name = ek_transformation.2002.c

		add_piety = medium_piety_gain

		reverse_add_opinion = {
			target = scope:owner
			modifier = hate_opinion
			opinion = -30
		}

		scope:owner = {
			trigger_event = ek_transformation.2005
		}

		stress_impact = {
			craven = medium_stress_impact_gain
			compassionate = minor_stress_impact_gain
			trusting = minor_stress_impact_gain
		}
	}
}

#SUCCESS EVENTS
scripted_trigger ek_transformation_2003_can_learn_owner_secret = {
	save_temporary_scope_as = secret_learner
	scope:owner = {
		any_secret = {
			secret_type = secret_vampire
			NOT = { is_known_by = scope:secret_learner }
		}
	}
}

scripted_trigger ek_transformation_2003_unlock_reveal_trigger = {
	NOT = { exists = scope:scheme_discovered }
	scope:target = { ek_transformation_2003_can_learn_owner_secret = yes }
}

ek_transformation.2003 = {
	type = character_event
	content_source = dlc_ek
	title = ek_transformation.2003.t
	desc = ek_transformation.2003.desc
	theme = witchcraft
	override_background = {
		reference = sitting_room
	}
	left_portrait = {
		character = scope:target
		animation = personality_rational
	}
	immediate = {
		scope:target = {
			give_vampire_secret_or_trait_effect = yes
			random_secret = {
				limit = { secret_type = secret_vampire }
				reveal_to = root
			}
		}
		if = {
			limit = { exists = scope:scheme_discovered }
			random_secret = {
				limit = {
					secret_type = secret_vampire
					NOT = { is_known_by = scope:target }
				}
				reveal_to = scope:target
			}

			reverse_add_opinion = {
				target = scope:target
				modifier = grateful_opinion
				opinion = 20
			}
		}
	}

	#Great!
	option = {
		trigger = { ek_transformation_2003_unlock_reveal_trigger = no }
		name = ek_transformation.2003.a

		scope:scheme = {
			end_scheme = yes
		}
	}
	
	#Let them know who I am
	option = {
		trigger = { ek_transformation_2003_unlock_reveal_trigger = yes }
		name = ek_transformation.2003.b

		scope:target = {
			send_interface_message = {
				type =  event_witchcraft_good
				title = ek_transformation.2003.message
				left_icon = scope:owner
				scope:owner = {
					random_secret = {
						limit = {
							secret_type = secret_vampire
							NOT = { is_known_by = scope:target }
						}
						reveal_to = scope:target
					}
				}
			}
		}

		reverse_add_opinion = {
			target = scope:target
			modifier = grateful_opinion
			opinion = 20
		}

		scope:scheme = {
			end_scheme = yes
		}

		ai_chance = {
			base = 100

			modifier = {
				has_trait = honest
				add = 50
			}
			modifier = {
				has_trait = trusting
				add = 100
			}
		}
	}

	#Keep my secret
	option = {
		trigger = { ek_transformation_2003_unlock_reveal_trigger = yes }
		name = ek_transformation.2003.c

		scope:scheme = {
			end_scheme = yes
		}

		ai_chance = {
			base = 50
			modifier = {
				has_trait = paranoid
				add = 100
			}
			modifier = {
				has_trait = craven
				add = 50
			}
			modifier = {
				has_trait = deceitful
				add = 50
			}
		}
	}

	after = {
		#Handle discover
		if = {
			limit = {
				exists = scope:scheme_discovered
				scope:target = {
					is_ai = yes
					OR = {
						AND = {
							is_ruler = no
							exists = liege
							liege = {
								ek_transformation_2003_can_learn_owner_secret = yes
								NOT = { this = scope:owner }
							}
						}
						any_relation = { type = lover ek_transformation_2003_can_learn_owner_secret = yes }
						any_consort = { ek_transformation_2003_can_learn_owner_secret = yes }
						any_child = {
							age >= 7
							ek_transformation_2003_can_learn_owner_secret = yes
						}
					}
				}
			}
			#Trigger the Overheard-event for the Scheme Owner
			trigger_event = ek_transformation.2010
		}
	}
}

#FAILURE EVENTS

#They refuse
ek_transformation.2004 = {
	type = character_event
	content_source = dlc_ek
	title = ek_transformation.2004.t
	desc = {
		desc = ek_transformation.2004.start.desc
		first_valid = {
			triggered_desc = {
				trigger = { exists = scope:scheme_discovered }
				desc = ek_transformation.2004.discovered.desc
			}
			desc = ek_transformation.2004.not_discovered.desc
		}
	}
	theme = witchcraft
	override_background = {
		reference = sitting_room
	}
	left_portrait = {
		character = scope:target
		animation = anger
	}

	immediate = {
		if = {
			limit = { exists = scope:scheme_discovered }
			random_secret = {
				limit = {
					secret_type = secret_vampire
					NOT = { is_known_by = scope:target }
				}
				reveal_to = scope:target
			}
			reverse_add_opinion = {
				target = scope:target
				modifier = impious_opinion
				opinion = -20
			}
		}
		scope:target = {
			add_character_flag = {	
				flag = block_convert_to_vampire
				days = 7300
			}
		}
	}
	
	option = {
		name = ek_transformation.2004.a

		scope:scheme = {
			end_scheme = yes
		}
	}
}

#They tell their liege
ek_transformation.2005 = {
	type = character_event
	content_source = dlc_ek
	title = ek_transformation.2004.t
	desc = {
		desc = ek_transformation.2004.start.desc
		desc = ek_transformation.2005.end.desc
	}
	theme = witchcraft
	override_background = {
		reference = sitting_room
	}
	left_portrait = {
		character = scope:target
		animation = anger
	}
	trigger = {
		scope:target = {
			exists = liege
			is_ruler = no
			liege = { NOT = { this = scope:owner } }
		}
		exists = scope:scheme_discovered
	}

	weight_multiplier = {
		base = 1

		ai_value_modifier = {
			who = scope:target
			ai_zeal = 0.05
			max = 2
			min = -0.5
		}
		opinion_modifier = {
			who = scope:target
			opinion_target = root
			multiplier = -0.05
			max = 2
			min = -0.5
		}
	}


	immediate = {
		random_secret = {
			limit = {
				secret_type = secret_vampire
			}
			if = {
				limit = { NOT = { is_known_by = scope:target } }
				reveal_to = scope:target
			}
			if = {
				limit = { NOT = { is_known_by = scope:target.liege } }
				reveal_to = scope:target.liege
			}
		}
		scope:target = {
			add_character_flag = {	
				flag = block_convert_to_vampire
				days = 7300
			}
		}
		reverse_add_opinion = {
			target = scope:target
			modifier = impious_opinion
			opinion = -20
		}
	}
	
	option = {
		name = ek_transformation.2005.a
		flavor = ek_transformation.2005.a.tt

		scope:scheme = {
			end_scheme = yes
		}
	}
}


#Target was already a vampire! Expose your secrets to each other - for owner
ek_transformation.2006 = { #by Linnéa Thimrén
	type = character_event
	content_source = dlc_ek
	title = ek_transformation.2006.t
	desc = ek_transformation.2006.desc
	theme = witchcraft
	override_background = {
		reference = sitting_room
	}
	left_portrait = {
		character = scope:target
		animation = shock
	}

	trigger = { #Make sure the secrets are still unknown and that target is alive and kicking
		any_scheme = {
			scheme_type = convert_to_vampire
			scheme_target_character = scope:target
		}
		scope:target = {
			is_alive = yes
			any_secret = {
				secret_type = secret_vampire
				NOT = {  any_secret_knower = { this = root } }
			}
		}
	}

	immediate = {
		scope:target = {
			random_secret = {
				limit = { secret_type = secret_vampire }
				reveal_to = root
			}
			trigger_event = ek_transformation.2007
		}
		random_secret = {
			limit = { secret_type = secret_vampire }
			reveal_to = scope:target
		}
		reverse_add_opinion = {
			target = scope:target
			modifier = respect_opinion
			opinion = 20
		}
	}

	#Great!
	option = {
		name = ek_transformation.2006.a
	}

	after = {
		scope:scheme = {
			end_scheme = yes
		}
	}
}


#Target was already a vampire! Expose your secrets to each other - for target
ek_transformation.2007 = { #by Linnéa Thimrén
	type = character_event
	content_source = dlc_ek
	title = ek_transformation.2007.t
	desc = ek_transformation.2007.desc
	theme = witchcraft
	override_background = {
		reference = sitting_room
	}
	left_portrait = {
		character = scope:owner
		animation = shock
	}

	trigger = { #Make sure the secrets are still unknown and that target is alive and kicking
		scope:owner = {
			is_alive = yes
			is_vampire = yes
		}
	}

	immediate = {
		show_as_tooltip = {
			scope:owner = {
				random_secret = {
					limit = { secret_type = secret_vampire }
					reveal_to = root
				}
			}
			random_secret = {
				limit = { secret_type = secret_vampire }
				reveal_to = scope:owner
			}
		}
		reverse_add_opinion = {
			target = scope:owner
			modifier = respect_opinion
			opinion = 20
		}
	}

	#Great!
	option = {
		name = ek_transformation.2007.a
	}
}

#Success, but discovered
ek_transformation.2010 = {
	type = character_event
	content_source = dlc_ek
	title = ek_transformation.2010.t
	desc = {
		first_valid = {
			triggered_desc = {
				trigger = {
					any_secret = {
						secret_type = secret_vampire
						is_known_by = scope:target
					}
				}
				desc = ek_transformation.talk.2010
			}
			desc = ek_transformation.leave.2010
		}
		desc = ek_transformation.end.2010
	}
	theme = witchcraft
	override_background = {
		reference = sitting_room
	}
	left_portrait = {
		character = scope:target
		animation = personality_rational
	}
	
	immediate = {
		hidden_effect = {
			scope:target = {
				random_list = {
					3 = {
						trigger = {
							is_ruler = no
							exists = liege
							liege = {
								ek_transformation_2003_can_learn_owner_secret = yes
								NOT = { this = scope:owner }
							}
						}
						liege = { save_scope_as = listener }
					}
					5 = {
						trigger = {
							any_relation = { 
								type = lover 
								ek_transformation_2003_can_learn_owner_secret = yes 
							}
						}
						random_relation = {
							type = lover
							limit = { ek_transformation_2003_can_learn_owner_secret = yes }
							save_scope_as = listener
						}
					}
					5 = {
						trigger = {
							any_consort = { ek_transformation_2003_can_learn_owner_secret = yes }
						}
						random_consort = {
							limit = { ek_transformation_2003_can_learn_owner_secret = yes }
							save_scope_as = listener
						}
					}
					1 = {
						trigger = {
							any_child = {
								age >= 7
								ek_transformation_2003_can_learn_owner_secret = yes
							}
						}
						random_child = {
							limit = {
								age >= 7
								ek_transformation_2003_can_learn_owner_secret = yes
							}
							save_scope_as = listener
						}
					}
				}
			}
			#Let's notify the Listener that they learned the secret
			scope:listener = {
				send_interface_message = {
					type = event_witchcraft_neutral
					title = ek_transformation.2010.message
					left_icon = scope:owner
					scope:owner = {
						random_secret = {
							limit = { secret_type = secret_vampire }
							reveal_to = scope:listener
						}
					}
				}
			}
		}
	}
	option = {
		name = ek_transformation.2010.a
		custom_tooltip = ek_transformation.2010.a.tt
	}
}


################
# LYCAN EVENTS #
################

##############################################
######COVERT TO LYCAN SCHEME EVENTS######
##############################################

#Do I want to go ahead with this?
ek_transformation.2101 = {
	type = character_event
	content_source = dlc_ek
	title = ek_transformation.2101.t
	desc = {
		desc = ek_transformation.2101.start.desc
		first_valid = {
			triggered_desc = {
				trigger = { trait_is_shunned_or_criminal_in_my_or_lieges_faith_trigger = { TRAIT = lycan_character GENDER_CHARACTER = root } }
				desc = ek_transformation.2101.secrecy.desc
			}
			desc = ek_transformation.2101.no_secrecy.desc
		}
		desc = ek_transformation.2101.end.desc
	}
	theme = witchcraft
	override_background = {
		reference = sitting_room
	}
	left_portrait = scope:target
	
	#Yes
	option = {
		name = ek_transformation.2101.a
		custom_tooltip = ek_transformation.2101.a.tt

		if = {
			limit = { scope:target = { is_ai = no } }
			scope:target = {
				trigger_event = {
					id = ek_transformation.2102
					days = 3
				}
			}
		}
		else_if = {
			limit = { exists = scope:scheme_successful }
			trigger_event = {
				id = ek_transformation.2103
				days = 3
			}
		}
		else = {
			trigger_event = {
				on_action = convert_to_lycan_failure_outcome
				days = 3
			}
		}

		ai_chance = {
			base = 100
		}
	}

	#No
	option = {
		name = {
			trigger = {
				use_convert_to_lycan_secrecy_trigger = { OWNER = root }
			}
			text = ek_transformation.2101.b1
		}
		name = {
			trigger = {
				use_convert_to_lycan_secrecy_trigger = { OWNER = root }
			}
			text = ek_transformation.2101.b2
		}
		scope:scheme = {
			end_scheme = yes
		}

		ai_chance = {
			base = 0
		}
	}
}


#Someone is trying to convert me to become a lycan (player only)
ek_transformation.2102 = {
	type = character_event
	content_source = dlc_ek
	title = ek_transformation.2102.t
	desc = {
		desc = ek_transformation.2102.start.desc
		first_valid = {
			triggered_desc = {
				trigger = { exists = scope:scheme_discovered }
				desc = ek_transformation.2102.discovery.desc
			}
			desc = ek_transformation.2102.no_discovery.desc
		}
		desc = ek_transformation.2102.end.desc
	}
	theme = witchcraft
	override_background = {
		reference = sitting_room
	}
	left_portrait = {
		character = scope:left_portrait
		triggered_animation = {
			trigger = { scope:left_portrait = root }
			animation = disbelief
		}
		animation = personality_dishonorable
	}
	
	immediate = {
		if = {
			limit = { exists = scope:scheme_discovered }
			scope:owner = {
				save_scope_as = left_portrait
				show_as_tooltip = {
					random_secret = {
						limit = {
							secret_type = secret_lycan
							NOT = { is_known_by = root }
						}
						reveal_to = root
					}
				}
			}
		}
		else = {
			save_scope_as = left_portrait
		}
	}

	#Yes I want to be a lycan
	option = {
		name = ek_transformation.2102.a

		show_as_tooltip = {
			give_lycan_secret_or_trait_effect = yes
		}

		if = {
			limit = {
				faith = {
					NOT = { has_doctrine_parameter = lycanthropy_accepted }
				}
			}
			add_piety = medium_piety_loss
		}
		
		scope:owner = {
			trigger_event = ek_transformation.2103
		}

		stress_impact = {
			zealous = massive_stress_impact_gain
			craven = medium_stress_impact_gain
		}
	}

	#No I don't want to be a lycan
	option = {
		name = ek_transformation.2102.b

		add_piety = medium_piety_gain

		scope:owner = {
			trigger_event = ek_transformation.2104
		}

		if = {
			limit = { exists = scope:scheme_discovered }
			reverse_add_opinion = {
				target = scope:owner
				modifier = disappointed_opinion
				opinion = -15
			}
		}

		stress_impact = {
			ambitious = minor_stress_impact_gain
		}
	}
	
	#Reveal them to the world!
	option = {
		trigger = { exists = scope:scheme_discovered }
		name = ek_transformation.2102.c

		add_piety = medium_piety_gain

		reverse_add_opinion = {
			target = scope:owner
			modifier = hate_opinion
			opinion = -30
		}

		scope:owner = {
			trigger_event = ek_transformation.2105
		}

		stress_impact = {
			craven = medium_stress_impact_gain
			compassionate = minor_stress_impact_gain
			trusting = minor_stress_impact_gain
		}
	}
}

#SUCCESS EVENTS
scripted_trigger ek_transformation_2103_can_learn_owner_secret = {
	save_temporary_scope_as = secret_learner
	scope:owner = {
		any_secret = {
			secret_type = secret_lycan
			NOT = { is_known_by = scope:secret_learner }
		}
	}
}

scripted_trigger ek_transformation_2103_unlock_reveal_trigger = {
	NOT = { exists = scope:scheme_discovered }
	scope:target = { ek_transformation_2103_can_learn_owner_secret = yes }
}

ek_transformation.2103 = {
	type = character_event
	content_source = dlc_ek
	title = ek_transformation.2103.t
	desc = ek_transformation.2103.desc
	theme = witchcraft
	override_background = {
		reference = sitting_room
	}
	left_portrait = {
		character = scope:target
		animation = personality_rational
	}
	immediate = {
		scope:target = {
			give_lycan_secret_or_trait_effect = yes
			random_secret = {
				limit = { secret_type = secret_lycan }
				reveal_to = root
			}
		}
		if = {
			limit = { exists = scope:scheme_discovered }
			random_secret = {
				limit = {
					secret_type = secret_lycan
					NOT = { is_known_by = scope:target }
				}
				reveal_to = scope:target
			}

			reverse_add_opinion = {
				target = scope:target
				modifier = grateful_opinion
				opinion = 20
			}
		}
	}

	#Great!
	option = {
		trigger = { ek_transformation_2103_unlock_reveal_trigger = no }
		name = ek_transformation.2103.a

		scope:scheme = {
			end_scheme = yes
		}
	}
	
	#Let them know who I am
	option = {
		trigger = { ek_transformation_2103_unlock_reveal_trigger = yes }
		name = ek_transformation.2103.b

		scope:target = {
			send_interface_message = {
				type = event_witchcraft_good
				title = ek_transformation.2103.message
				left_icon = scope:owner
				scope:owner = {
					random_secret = {
						limit = {
							secret_type = secret_lycan
							NOT = { is_known_by = scope:target }
						}
						reveal_to = scope:target
					}
				}
			}
		}

		reverse_add_opinion = {
			target = scope:target
			modifier = grateful_opinion
			opinion = 20
		}

		scope:scheme = {
			end_scheme = yes
		}

		ai_chance = {
			base = 100

			modifier = {
				has_trait = honest
				add = 50
			}
			modifier = {
				has_trait = trusting
				add = 100
			}
		}
	}

	#Keep my secret
	option = {
		trigger = { ek_transformation_2103_unlock_reveal_trigger = yes }
		name = ek_transformation.2103.c

		scope:scheme = {
			end_scheme = yes
		}

		ai_chance = {
			base = 50
			modifier = {
				has_trait = paranoid
				add = 100
			}
			modifier = {
				has_trait = craven
				add = 50
			}
			modifier = {
				has_trait = deceitful
				add = 50
			}
		}
	}

	after = {
		#Handle discover
		if = {
			limit = {
				exists = scope:scheme_discovered
				scope:target = {
					is_ai = yes
					OR = {
						AND = {
							is_ruler = no
							exists = liege
							liege = {
								ek_transformation_2103_can_learn_owner_secret = yes
								NOT = { this = scope:owner }
							}
						}
						any_relation = { type = lover ek_transformation_2103_can_learn_owner_secret = yes }
						any_consort = { ek_transformation_2103_can_learn_owner_secret = yes }
						any_child = {
							age >= 7
							ek_transformation_2103_can_learn_owner_secret = yes
						}
					}
				}
			}
			#Trigger the Overheard-event for the Scheme Owner
			trigger_event = ek_transformation.2110
		}
	}
}

#FAILURE EVENTS

#They refuse
ek_transformation.2104 = {
	type = character_event
	content_source = dlc_ek
	title = ek_transformation.2104.t
	desc = {
		desc = ek_transformation.2104.start.desc
		first_valid = {
			triggered_desc = {
				trigger = { exists = scope:scheme_discovered }
				desc = ek_transformation.2104.discovered.desc
			}
			desc = ek_transformation.2104.not_discovered.desc
		}
	}
	theme = witchcraft
	override_background = {
		reference = sitting_room
	}
	left_portrait = {
		character = scope:target
		animation = anger
	}

	immediate = {
		if = {
			limit = { exists = scope:scheme_discovered }
			random_secret = {
				limit = {
					secret_type = secret_lycan
					NOT = { is_known_by = scope:target }
				}
				reveal_to = scope:target
			}
			reverse_add_opinion = {
				target = scope:target
				modifier = impious_opinion
				opinion = -20
			}
		}
		scope:target = {
			add_character_flag = {	
				flag = block_convert_to_lycan
				days = 7300
			}
		}
	}
	
	option = {
		name = ek_transformation.2104.a

		scope:scheme = {
			end_scheme = yes
		}
	}
}

#They tell their liege
ek_transformation.2105 = {
	type = character_event
	content_source = dlc_ek
	title = ek_transformation.2104.t
	desc = {
		desc = ek_transformation.2104.start.desc
		desc = ek_transformation.2105.end.desc
	}
	theme = witchcraft
	override_background = {
		reference = sitting_room
	}
	left_portrait = {
		character = scope:target
		animation = anger
	}
	trigger = {
		scope:target = {
			exists = liege
			is_ruler = no
			liege = { NOT = { this = scope:owner } }
		}
		exists = scope:scheme_discovered
	}

	weight_multiplier = {
		base = 1

		ai_value_modifier = {
			who = scope:target
			ai_zeal = 0.05
			max = 2
			min = -0.5
		}
		opinion_modifier = {
			who = scope:target
			opinion_target = root
			multiplier = -0.05
			max = 2
			min = -0.5
		}
	}


	immediate = {
		random_secret = {
			limit = {
				secret_type = secret_lycan
			}
			if = {
				limit = { NOT = { is_known_by = scope:target } }
				reveal_to = scope:target
			}
			if = {
				limit = { NOT = { is_known_by = scope:target.liege } }
				reveal_to = scope:target.liege
			}
		}
		scope:target = {
			add_character_flag = {	
				flag = block_convert_to_lycan
				days = 7300
			}
		}
		reverse_add_opinion = {
			target = scope:target
			modifier = impious_opinion
			opinion = -20
		}
	}
	
	option = {
		name = ek_transformation.2105.a
		flavor = ek_transformation.2105.a.tt

		scope:scheme = {
			end_scheme = yes
		}
	}
}


#Target was already a lycan! Expose your secrets to each other - for owner
ek_transformation.2106 = { #by Linnéa Thimrén
	type = character_event
	content_source = dlc_ek
	title = ek_transformation.2106.t
	desc = ek_transformation.2106.desc
	theme = witchcraft
	override_background = {
		reference = sitting_room
	}
	left_portrait = {
		character = scope:target
		animation = shock
	}

	trigger = { #Make sure the secrets are still unknown and that target is alive and kicking
		any_scheme = {
			scheme_type = convert_to_lycan
			scheme_target_character = scope:target
		}
		scope:target = {
			is_alive = yes
			any_secret = {
				secret_type = secret_lycan
				NOT = {  any_secret_knower = { this = root } }
			}
		}
	}

	immediate = {
		scope:target = {
			random_secret = {
				limit = { secret_type = secret_lycan }
				reveal_to = root
			}
			trigger_event = ek_transformation.2107
		}
		random_secret = {
			limit = { secret_type = secret_lycan }
			reveal_to = scope:target
		}
		reverse_add_opinion = {
			target = scope:target
			modifier = respect_opinion
			opinion = 20
		}
	}

	#Great!
	option = {
		name = ek_transformation.2106.a
	}

	after = {
		scope:scheme = {
			end_scheme = yes
		}
	}
}


#Target was already a lycan! Expose your secrets to each other - for target
ek_transformation.2107 = { #by Linnéa Thimrén
	type = character_event
	content_source = dlc_ek
	title = ek_transformation.2107.t
	desc = ek_transformation.2107.desc
	theme = witchcraft
	override_background = {
		reference = sitting_room
	}
	left_portrait = {
		character = scope:owner
		animation = shock
	}

	trigger = { #Make sure the secrets are still unknown and that target is alive and kicking
		scope:owner = {
			is_alive = yes
			is_lycan = yes
		}
	}

	immediate = {
		show_as_tooltip = {
			scope:owner = {
				random_secret = {
					limit = { secret_type = secret_lycan }
					reveal_to = root
				}
			}
			random_secret = {
				limit = { secret_type = secret_lycan }
				reveal_to = scope:owner
			}
		}
		reverse_add_opinion = {
			target = scope:owner
			modifier = respect_opinion
			opinion = 20
		}
	}

	#Great!
	option = {
		name = ek_transformation.2107.a
	}
}

#Success, but discovered
ek_transformation.2110 = {
	type = character_event
	content_source = dlc_ek
	title = ek_transformation.2110.t
	desc = {
		first_valid = {
			triggered_desc = {
				trigger = {
					any_secret = {
						secret_type = secret_lycan
						is_known_by = scope:target
					}
				}
				desc = ek_transformation.talk.2110
			}
			desc = ek_transformation.leave.2110
		}
		desc = ek_transformation.end.2110
	}
	theme = witchcraft
	override_background = {
		reference = sitting_room
	}
	left_portrait = {
		character = scope:target
		animation = personality_rational
	}
	
	immediate = {
		hidden_effect = {
			scope:target = {
				random_list = {
					3 = {
						trigger = {
							is_ruler = no
							exists = liege
							liege = {
								ek_transformation_2103_can_learn_owner_secret = yes
								NOT = { this = scope:owner }
							}
						}
						liege = { save_scope_as = listener }
					}
					5 = {
						trigger = {
							any_relation = { 
								type = lover 
								ek_transformation_2103_can_learn_owner_secret = yes 
							}
						}
						random_relation = {
							type = lover
							limit = { ek_transformation_2103_can_learn_owner_secret = yes }
							save_scope_as = listener
						}
					}
					5 = {
						trigger = {
							any_consort = { ek_transformation_2103_can_learn_owner_secret = yes }
						}
						random_consort = {
							limit = { ek_transformation_2103_can_learn_owner_secret = yes }
							save_scope_as = listener
						}
					}
					1 = {
						trigger = {
							any_child = {
								age >= 7
								ek_transformation_2103_can_learn_owner_secret = yes
							}
						}
						random_child = {
							limit = {
								age >= 7
								ek_transformation_2103_can_learn_owner_secret = yes
							}
							save_scope_as = listener
						}
					}
				}
			}
			#Let's notify the Listener that they learned the secret
			scope:listener = {
				send_interface_message = {
					type = event_witchcraft_neutral
					title = ek_transformation.2110.message
					left_icon = scope:owner
					scope:owner = {
						random_secret = {
							limit = { secret_type = secret_lycan }
							reveal_to = scope:listener
						}
					}
				}
			}
		}
	}
	option = {
		name = ek_transformation.2110.a
		custom_tooltip = ek_transformation.2110.a.tt
	}
}